|--------------------------------------------------------------------------------|
| Aula      : Crosscheck e delete backup                                         |
| MÃ³dulo    : Basic Backup and Recovery                                          |
| Curso     : Oracle Fundamentals                                                |
| Instrutor : Marcio Mandarino                                                   |
| URL       : mrdba.com.br/oracle_fundamentals                                   |
|--------------------------------------------------------------------------------|
| ReferÃªncia: https://docs.oracle.com/en/database/oracle/oracle-database/19/bradv/maintaining-rman-backups.html
|--------------------------------------------------------------------------------|


=================================================================
== ðŸŽ¯ Objetivos da Aula:
=================================================================
ðŸ’¡ Aprender a fazer a manutenÃ§Ã£o dos arquivos de backup do servidor

=================================================================
== ðŸŽ¯ Resumo
=================================================================
ðŸ“ Crosscheck backup
ðŸ“ Delete backup
ðŸ“ CenÃ¡rio prÃ¡tico
ðŸ“ Fazendo tudo de uma vez
ðŸ“ ConclusÃ£o


=================================================================
== ðŸŽ¯ Conceito Geral
=================================================================
â–¶ï¸ Quando configuramos bem a rotina de backup do RMAN, nÃ£o precisamos ficar lidando com arquivos de backup
â–¶ï¸ Executamos processos que vÃ£o por em prÃ¡tica aquilo que configuramos previamente


=================================================================
== ðŸŽ¯ Crosscheck backup
=================================================================
â–¶ï¸ O crosscheck faz o sincronismo da realidade fÃ­sica com o que estÃ¡ no catÃ¡logo do RMAN
â–¶ï¸ Essa Ã© uma atividade de manutenÃ§Ã£o dos backups muito importante de ser realizada
â–¶ï¸ O crosscheck nÃ£o exclui arquivos de backup, ele apenas "marca" os arquivos de backup, definindo seu status
â–¶ï¸ O que vai determinar o status dos arquivos de backup Ã© a polÃ­tica de retenÃ§Ã£o do backup
â–¶ï¸ Um arquivo pode ter os seguintes status:
  â–«ï¸ AVAILABLE: DisponÃ­vel e faz parte da polÃ­tica de backup
  â–«ï¸ OBSOLETE: SÃ£o arquivos que estÃ£o disponÃ­veis, porÃ©m nÃ£o sÃ£o mais necessÃ¡rios para a polÃ­tica de backup atual
  â–«ï¸ EXPIRED: SÃ£o arquivos de backup que nÃ£o foram encontrados (provavelmente, excluÃ­dos manualmente)


=================================================================
== ðŸŽ¯ Delete backup
=================================================================
â–¶ï¸ O delete backup faz a exclusÃ£o de backups
â–¶ï¸ Normalmente Ã© utilizado para excluir backups obsoletos e/ou expirados
â–¶ï¸ Mas tambÃ©m pode ser utilizado para excluir backups especÃ­ficos


RMAN> backup database plus archivelog tag 'excluir';
RMAN> delete noprompt backupset tag 'excluir';


=================================================================
== ðŸŽ¯ CenÃ¡rio prÃ¡tico
=================================================================
â–¶ï¸ Definir a polÃ­tica de retenÃ§Ã£o para 1 backup em disco
$ . oraenv  
$ rman target / 
rman> configure retention policy to redundancy 1;
RMAN> configure archivelog deletion policy to backed up 1 times to device type disk;

RMAN> backup as compressed backupset tag 'bkp1' database plus archivelog tag 'bkp1';
RMAN> backup as compressed backupset tag 'bkp2' database plus archivelog tag 'bkp2';
RMAN> backup as compressed backupset tag 'bkp3' database plus archivelog tag 'bkp3';
RMAN> list backup tag 'bkp1';
RMAN> list backup tag 'bkp2';
RMAN> list backup tag 'bkp3';

-- Abrir uma nova sessÃ£o e excluir os arquivos de backup do bkp1
# rm -rf /backup/ORCL/backupset/2024_07_08/*BKP1*



-- Voltar para a sessÃ£o anterior
RMAN> list backup tag 'bkp1';

-- Executar o crosscheck
RMAN> run
{
  crosscheck backup;
  crosscheck archivelog all;
}

RMAN> report obsolete;


RMAN> delete noprompt expired backup;
RMAN> delete noprompt expired archivelog all;
RMAN> delete noprompt obsolete;

RMAN> list backup tag 'bkp1';
RMAN> list backup tag 'bkp2';
RMAN> list backup tag 'bkp3';


=================================================================
== ðŸŽ¯ Fazendo tudo de uma vez
=================================================================
RMAN> run
{
  crosscheck backup;
  crosscheck archivelog all;
  delete noprompt expired backup;
  delete noprompt expired archivelog all;
  delete noprompt obsolete;
  report need backup;
}

5 dias

apagando arquivos com de 5 dias


=================================================================
== ðŸŽ¯ ConclusÃ£o
=================================================================
ðŸ’¡ O DBA nÃ£o fica apagando arquivos de backup, ele controla a polÃ­tica usando o crosscheck e delete
ðŸ’¡ Pratique a execuÃ§Ã£o dos comandos desta aula
ðŸ’¡ Tente escrever os comandos para fixar, nÃ£o copie e cole
 