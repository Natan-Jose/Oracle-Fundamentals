
| Aula      : Recuperando o database em outro servidor			 										|
| MÃ³dulo    : Basic Backup and Recovery                                         |
| Curso     : Oracle Fundamentals                                               |
| Instrutor : Marcio Mandarino                                                  |
| URL       : mrdba.com.br/oracle_fundamentals                                  |
|-------------------------------------------------------------------------------|
| ReferÃªncia: https://docs.oracle.com/en/database/oracle/oracle-database/19/bradv/rman-complete-database-recovery.html#GUID-4EBD9D56-9700-45A1-B233-1F5506A04532
|-------------------------------------------------------------------------------|


=================================================================
== ğŸ¯ Objetivos da Aula:
=================================================================
ğŸ’¡ Aprender como restaurar um banco de forma completa em outro servidor

=================================================================
== ğŸ¯ Resumo
=================================================================
ğŸ“ Conceito geral
ğŸ“ Steps para o restore do banco completo
ğŸ“ Criando uma tabela de teste
ğŸ“ Fazendo backup no banco de origem
ğŸ“ Criando diretÃ³rios no servidor de destino
ğŸ“ Copiando o backup do servidor de origem para o destino
ğŸ“ Restaurando o spfile
ğŸ“ Restaurando o Control File
ğŸ“ Catalogando as peÃ§as de backup
ğŸ“ Restaurando o Database
ğŸ“ Executando o recover
ğŸ“ Abrindo o banco de dados
ğŸ“ Consultando o estado do banco de dados
ğŸ“ Excluindo o banco de dados criado
ğŸ“ Efetuando um novo restore
ğŸ“ ConclusÃ£o



/u01 binarios
/u02 datafiles
/u03 multiplex redo e control file
/backup backups




=================================================================
== ğŸ¯ Conceito geral
=================================================================
â–¶ï¸ Efetuar um restore completo do banco de dados Ã© um passo importante para compreender as etapas da recuperaÃ§Ã£o do banco
â–¶ï¸ Para fins didÃ¡ticos, esse restore ocorre em um ambiente equivalente a produÃ§Ã£o, porÃ©m podem ocorrer mudanÃ§as de:
	â–«ï¸ Estrutura de diretÃ³rios
	â–«ï¸ Nome do banco de dados
	â–«ï¸ Sistema Operacional (Windows para Linux, por exemplo)
	â–«ï¸ VersÃ£o do Oracle
âš ï¸ Quando ocorre mudanÃ§as como exemplificado acima, novos steps sÃ£o necessÃ¡rios, porÃ©m o conceito Ã© o mesmo
â–¶ï¸ VocÃª pode usar esse processo para diversos fins:
	â–«ï¸ ReplicaÃ§Ã£o de bases (criaÃ§Ã£o de ambientes de testes, homolog, etc)
	â–«ï¸ RecuperaÃ§Ã£o do banco de dados em caso de perda de hardware
	â–«ï¸ MigraÃ§Ã£o de dados
	â–«ï¸ Teste de Restore
ğŸ’¡ Sempre incentive a empresa a ter um processo de teste de restore, Ã© bom para a empresa e para o DBA!




=================================================================
== ğŸ¯ Steps para o restore do banco completo
=================================================================
â–¶ï¸ Backup Full do banco de origem
â–¶ï¸ TransferÃªncia do backup do servidor de origem para o servidor de destino
â–¶ï¸ Abrir o banco como nomount
â–¶ï¸ Restore do spfile
â–¶ï¸ Restore do Control File
â–¶ï¸ Abrir o banco como mount
â–¶ï¸ Catalogar as peÃ§as de backup
â–¶ï¸ Restore do Database
â–¶ï¸ Recover do database
â–¶ï¸ Abrir o banco com a opÃ§Ã£o resetlogs


=================================================================
== ğŸ¯ Criando uma tabela de teste
=================================================================
$ . oraenv
$ sqlplus / as sysdba
SQL> create table tb_test (data date);
SQL> insert into tb_test values (sysdate);
SQL> commit;
SQL> exit;


=================================================================
== ğŸ¯ Fazendo backup no banco de origem
=================================================================
$ . oraenv
$ rman target /


RMAN> run
{
allocate channel ch01 device type disk;
allocate channel ch02 device type disk;
allocate channel ch03 device type disk;
allocate channel ch04 device type disk;
backup
  as compressed backupset
  skip inaccessible
  tag bkp_pontual
  database plus archivelog;
backup
  tag bkp_pontual_ctfile
    (current controlfile);
backup
  tag bkp_pontual_spfile
   (spfile);
release channel ch01;
release channel ch02;
release channel ch03;
release channel ch04;
}


=================================================================
== ğŸ¯ Criando diretÃ³rios no servidor de destino
=================================================================
-- DiretÃ³rio para o backup
$ mkdir /backup/restore_prod

-- DiretÃ³rio para 
$ mkdir -p /u01/app/oracle/admin/orcl/adump

=================================================================
== ğŸ¯ Copiando o backup do servidor de origem para o destino
=================================================================
$ scp /backup/ORCL/backupset/2024_07_09/*BKP_PONTUAL* oracle@192.168.68.114:/backup/restore_prod/


ls -lhtr /backup/ORCL/backupset/2024_07_09/*BKP_PONTUAL*

=================================================================
== ğŸ¯ Restaurando o spfile
=================================================================
$ export ORACLE_SID=orcl
$ export ORACLE_BASE=/u01/app/oracle
$ export ORACLE_HOME=/u01/app/oracle/product/19c/db_1
$ export PATH=$ORACLE_HOME/bin:$PATH

$ rman target /
RMAN> startup nomount;
RMAN> restore spfile from '/backup/restore_prod/o1_mf_nnsnf_BKP_PONTUAL_SPFILE_m8tgxyz6_.bkp';
RMAN> shutdown immediate;
RMAN> startup nomount;


$ ls -lhtr /u01/app/oracle/product/19c/db_1/dbs/


=================================================================
== ğŸ¯ Restaurando o Control File
=================================================================
RMAN> restore controlfile from '/backup/restore_prod/o1_mf_ncnnf_BKP_PONTUAL_CTFILE_m8tgxxrj_.bkp';
RMAN> alter database mount;


=================================================================
== ğŸ¯ Catalogando as peÃ§as de backup
=================================================================
RMAN> catalog start with '/backup/restore_prod/' noprompt;


=================================================================
== ğŸ¯ Restaurando o Database
=================================================================
RMAN> restore database;


=================================================================
== ğŸ¯ Executando o recover 
=================================================================
RMAN> recover database until available redo;



=================================================================
== ğŸ¯ Abrindo o banco de dados
=================================================================
RMAN> alter database open resetlogs;
RMAN> exit


=================================================================
== ğŸ¯ Consultando o estado do banco de dados
=================================================================
$ sqlplus / as sysdba
SQL> select DBID,NAME,CREATED,RESETLOGS_TIME,OPEN_MODE from v$database;

SQL> select to_char(data,'DD/MM/RRRR HH24:MI:SS') DATA from tb_test;
SQL> exit

=================================================================
== ğŸ¯ Excluindo o banco de dados criado
=================================================================
$ sqlplus / as sysdba
SQL> shutdown abort;
SQL> exit


$ rm -rf /u02/oradata/ORCL/
$ rm -rf /u03/oradata/ORCL/
$ rm -rf /u01/app/oracle/product/19c/db_1/dbs/spfileorcl.ora
$ rm -rf /backup/ORCL/



=================================================================
== ğŸ¯ Efetuando um novo restore
=================================================================
$ mkdir -p /u01/app/oracle/admin/orcl/adump
$ export ORACLE_SID=orcl
$ export ORACLE_BASE=/u01/app/oracle
$ export ORACLE_HOME=/u01/app/oracle/product/19c/db_1
$ export PATH=$ORACLE_HOME/bin:$PATH




$ rman target /

RMAN> startup nomount;

RMAN> run 
{
allocate channel ch01 device type disk;
allocate channel ch02 device type disk;
allocate channel ch03 device type disk;
allocate channel ch04 device type disk;
restore spfile from '/backup/restore_prod/o1_mf_nnsnf_BKP_PONTUAL_SPFILE_m8tgxyz6_.bkp';
shutdown immediate;
startup nomount;
restore controlfile from '/backup/restore_prod/o1_mf_ncnnf_BKP_PONTUAL_CTFILE_m8tgxxrj_.bkp';
alter database mount;
catalog start with '/backup/restore_prod/' noprompt;
restore database;
recover database until available redo;
alter database open resetlogs;
release channel ch01;
release channel ch02;
release channel ch03;
release channel ch04;
}



=================================================================
== ğŸ¯ ConclusÃ£o
=================================================================
ğŸ’¡ Dominando essa competÃªncia e colocando em prÃ¡tica em algum lugar, vocÃª estarÃ¡ mais prÃ³ximo de se tornar um DBA Pleno
ğŸ’¡ Pratique a execuÃ§Ã£o dos comandos desta aula
ğŸ’¡ Existem vÃ¡rios cenÃ¡rios de recuperaÃ§Ã£o, nÃ£o ache que tudo serÃ¡ tÃ£o simples assim!
 