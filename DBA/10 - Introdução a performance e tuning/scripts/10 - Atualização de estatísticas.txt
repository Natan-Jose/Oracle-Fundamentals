|-------------------------------------------------------------------------------|
| Aula      : AtualizaÃ§Ã£o de estatÃ­sticas										|
| MÃ³dulo    : IntroducÌ§aÌƒo a performance e tuning                                 |
| Curso     : Oracle Fundamentals                                               |
| Instrutor : Marcio Mandarino                                                  |
| URL       : mrdba.com.br/oracle_fundamentals                                  |
|-------------------------------------------------------------------------------|
| ReferÃªncia: https://docs.oracle.com/en/database/oracle/oracle-database/19/tgsql/gathering-optimizer-statistics.html#GUID-A3E66485-F827-494E-99D7-6E4558E9CC21
|-------------------------------------------------------------------------------|


=================================================================
== ğŸ¯ Objetivos da Aula:
=================================================================
ğŸ’¡ Aprender quando e como coletar estatÃ­sticas no Oracle

=================================================================
== ğŸ¯ Resumo
=================================================================
ğŸ“ Conceito geral
ğŸ“ Por Que Coletar estatÃ­sticas
ğŸ“ Quando Coletar as estatÃ­sticas
ğŸ“ Coleta de estatÃ­stica automÃ¡tica
ğŸ“ PrecauÃ§Ãµes ao coletar estatÃ­ticas
ğŸ“ O Pacote dbms_stats
ğŸ“ DBMS_STATS.GATHER_SCHEMA_STATS
ğŸ“ DBMS_STATS.GATHER_TABLE_STATS
ğŸ“ DBMS_STATS.GATHER_DATABASE_STATS
ğŸ“ DBMS_STATS.GATHER_DICTIONARY_STATS
ğŸ“ DBMS_STATS.GATHER_DICTIONARY_STATS
ğŸ“ Monitorando as informaÃ§Ãµes de estatÃ­sticas coletadas
ğŸ“ Criando um cenÃ¡rio de exclusÃ£o em massa
ğŸ“ Minha visÃ£o sobre coleta de estatÃ­sticas
ğŸ“ ConclusÃ£o

=================================================================
== ğŸ¯ Conceito geral
=================================================================
â–¶ï¸ A coleta de estatÃ­sticas Ã© essencial para a manutenÃ§Ã£o do desempenho do banco de dados Oracle
â–¶ï¸ EstatÃ­sticas precisas permitem ao otimizador de consultas (Query Optimizer) gerar planos de execuÃ§Ã£o eficientes
â–¶ï¸ resulta em consultas mais rÃ¡pidas e uso otimizado dos recursos do sistema.


=================================================================
== ğŸ¯ Por Que Coletar estatÃ­sticas
=================================================================
â–¶ï¸ Garantir que o otimizador de consultas tenha informaÃ§Ãµes atualizadas sobre a distribuiÃ§Ã£o dos dados.
â–¶ï¸ Melhorar o desempenho das consultas ao permitir que o otimizador escolha os melhores planos de execuÃ§Ã£o.
â–¶ï¸ Evitar problemas de desempenho causados por estatÃ­sticas desatualizadas ou imprecisas.


=================================================================
== ğŸ¯ Quando Coletar as estatÃ­sticas
=================================================================
â–¶ï¸ ApÃ³s grandes operaÃ§Ãµes de carga de dados
â–¶ï¸ ApÃ³s operaÃ§Ãµes de manutenÃ§Ã£o de dados em larga escala (e.g., INSERT, UPDATE, DELETE em massa)
â–¶ï¸ Periodicamente, com base em um cronograma de manutenÃ§Ã£o preventiva


=================================================================
== ğŸ¯ Coleta de estatÃ­stica automÃ¡tica
=================================================================
â–¶ï¸ O Oracle coleta automaticamente as estatÃ­sticas dos segmentos dentro de uma janela de manutenÃ§Ã£o predefinida 
â–¶ï¸ Teoricamente, nÃ£o precisamos nos preocupar com a coleta das estatÃ­ticas, exceto as situaÃ§Ãµes citadas acima
â–¶ï¸ Muitos DBAs gostam de manter uma coleta regular de estatÃ­stica do banco, independentemente da janela de manutenÃ§Ã£o
	â–«ï¸ Eu sou um deles ğŸ™‚


=================================================================
== ğŸ¯ PrecauÃ§Ãµes ao coletar estatÃ­ticas
=================================================================
â–¶ï¸ Ã‰ um processo tranquilo de se fazer, porÃ©m requer muito CPU e I/O
â–¶ï¸ Procure fazer em horÃ¡rios alternativos
âš ï¸ AtenÃ§Ã£o para coleta de estatÃ­sticas de objetos grandes


=================================================================
== ğŸ¯ O Pacote dbms_stats
=================================================================
â–¶ï¸ Existem vÃ¡rias procedures no pacote dbms_stats, as mais comuns sÃ£o:
	â–«ï¸ GATHER_SCHEMA_STATS
	â–«ï¸ GATHER_TABLE_STATS
	â–«ï¸ GATHER_DATABASE_STATS
	â–«ï¸ GATHER_DICTIONARY_STATS


=================================================================
== ğŸ¯ DBMS_STATS.GATHER_SCHEMA_STATS
=================================================================
â–¶ï¸ Coleta as estatÃ­ticas de todos os segmentos do schema

SQL> EXEC DBMS_STATS.GATHER_SCHEMA_STATS('SOE');
SQL> EXEC DBMS_STATS.GATHER_SCHEMA_STATS('SOE', cascade => TRUE);
SQL> EXEC DBMS_STATS.GATHER_SCHEMA_STATS('SOE', cascade => TRUE, degree => 4);

ğŸ’¡ O parÃ¢metro cascade atualiza as estatÃ­sticas da tabela e de seus respectivos Ã­ndices
ğŸ’¡ O parÃ¢metro degree faz a operaÃ§Ã£o em paralelismo (disponÃ­vel apenas no EE)


=================================================================
== ğŸ¯ DBMS_STATS.GATHER_TABLE_STATS
=================================================================
â–¶ï¸ Coleta as estatÃ­ticas de uma determinada tabela

SQL> EXEC DBMS_STATS.GATHER_TABLE_STATS('SOE', tabname => 'WAREHOUSES', cascade => TRUE, degree => 4);


=================================================================
== ğŸ¯ DBMS_STATS.GATHER_DATABASE_STATS
=================================================================
â–¶ï¸ Coleta as estatÃ­stica do database inteiro

SQL> EXEC DBMS_STATS.GATHER_DATABASE_STATS(degree => 4);


=================================================================
== ğŸ¯ DBMS_STATS.GATHER_DICTIONARY_STATS
=================================================================
â–¶ï¸ Coleta as estatÃ­stica do dicionÃ¡iro de dados



=================================================================
== ğŸ¯ DBMS_STATS.GATHER_DICTIONARY_STATS
=================================================================
SQL> EXEC DBMS_STATS.GATHER_DICTIONARY_STATS(degree => 4);


=================================================================
== ğŸ¯ Monitorando as informaÃ§Ãµes de estatÃ­sticas coletadas
=================================================================
â–¶ï¸ VocÃª pode monitorar quando as estatÃ­sticas foram coletadas
	â–«ï¸ DBA_TAB_STATISTICS (Coluna LAST_ANALYZED)
	â–«ï¸ DBA_IND_STATISTICS (Coluna LAST_ANALYZED)
	â–«ï¸ DBA_TABLES (Coluna LAST_ANALYZED)
	â–«ï¸ DBA_INDEXES (Coluna LAST_ANALYZED)

SQL> select owner, table_name, num_rows, last_analyzed from dba_tables where owner = 'SOE';


=================================================================
== ğŸ¯ Criando um cenÃ¡rio de exclusÃ£o em massa
=================================================================

-- Criando uma carga
SQL> set lines 200
SQL> create table tb_stats as (select * from dba_objects);
SQL> insert into tb_stats (select * from dba_objects);
SQL> insert into tb_stats (select * from dba_objects);
SQL> commit;


-- Verificando as informaÃ§Ãµes da tabela
SQL> select count(1) from tb_stats;
SQL> COL TABLE_NAME FORM A20
SQL> COL NUM_ROWS FORM 999,999,999
SQL> SELECT table_name, num_rows,to_char(LAST_ANALYZED,'DD/MM/RRRR HH24:MI:SS') LAST_ANALYZED, stale_stats FROM dba_tab_statistics WHERE table_name = 'TB_STATS';
SQL> EXEC DBMS_STATS.GATHER_TABLE_STATS('SYS', tabname => 'TB_STATS', cascade => TRUE, degree => 4);


-- Simulando uma exclusÃ£o em massa
SQL> delete from tb_stats;
SQL> select count(1) from tb_stats;


-- Verificando as
SQL> COL TABLE_NAME FORM A20
SQL> COL NUM_ROWS FORM 999,999,999
SQL> SELECT table_name, num_rows,to_char(LAST_ANALYZED,'DD/MM/RRRR HH24:MI:SS') LAST_ANALYZED, stale_stats FROM dba_tab_statistics WHERE table_name = 'TB_STATS';


SQL> EXEC DBMS_STATS.GATHER_TABLE_STATS('SYS', tabname => 'TB_STATS', cascade => TRUE, degree => 4);

SQL> drop table tb_stats;




=================================================================
== ğŸ¯ Minha visÃ£o sobre coleta de estatÃ­sticas
=================================================================
â–¶ï¸ No passado, era algo obrigatÃ³rio, pois antes do Oracle 10g, as coletas eram manuais
â–¶ï¸ DBAs mais antigos, ficaram com a ideia da necessidade/obrigatoriedade da coleta de estatÃ­sticas (eu sou um deles)
â–¶ï¸ Minha lihha de pensamento Ã©:
	â–«ï¸ "Se bem nÃ£o fizer, mal nÃ£o farÃ¡"
	â–«ï¸ Se tem janela para executar a coleta de estatÃ­sticas, por que nÃ£o? 
	â–«ï¸ Pra que correr o risco do plano de manutenÃ§Ã£o nÃ£o conseguir fazer tudo que ele precisa fazer?	


=================================================================
== ğŸ¯ ConclusÃ£o
=================================================================
ğŸ’¡ Saiba quando coletar estatÃ­sticas do banco
ğŸ’¡ Saiba como coletar estatÃ­sticas do banco
ğŸ’¡ Digite os comandos para fixar o conhecimento, mas nÃ£o se apegue a decorar comandos, entenda o conceito.
