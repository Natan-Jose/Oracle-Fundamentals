|-------------------------------------------------------------------------------|
| Aula      : Automatic Workload Repository 					   |
| MÃ³dulo    : Managing Oracle Database                                          |
| Curso     : Oracle Fundamentals                                               |
| Instrutor : Marcio Mandarino                                                  |
| URL       : mrdba.com.br/oracle_fundamentals                                  |
|-------------------------------------------------------------------------------|
| ReferÃªncia: https://docs.oracle.com/en/database/oracle/oracle-database/19/tgdba/gathering-database-statistics.html#GUID-CBB1716F-2B20-4575-ADCE-94E33BEA53EF
|-------------------------------------------------------------------------------|


=================================================================
== ğŸ¯ Objetivos da Aula:
=================================================================
ğŸ’¡ Aprender a utilizar o AWR

=================================================================
== ğŸ¯ Resumo
=================================================================
ğŸ“ Conceito geral
ğŸ“ Quando utilizar o AWR
ğŸ“ BenefÃ­cios do AWR
ğŸ“ ConfiguraÃ§Ãµes do AWR
ğŸ“ Modificando as configuraÃ§Ãµes do AWR
ğŸ“ Criando um snapshot manualmente
ğŸ“ Excluindo snapshots
ğŸ“ Criando uma baseline
ğŸ“ Scripts para gerar relatÃ³rios AWR
ğŸ“ Gerando relatÃ³rios AWR
ğŸ“ ConclusÃ£o

=================================================================
== ğŸ¯ Conceito geral
=================================================================
â–¶ï¸ O Automatic Workload Repository (AWR) Ã© um repositÃ³rio que coleta, processa e mantÃ©m estatÃ­sticas de desempenho do banco de dados. 
â–¶ï¸ Essas estatÃ­sticas sÃ£o usadas pelo Automatic Database Diagnostic Monitor (ADDM) para identificar problemas de desempenho.
â–¶ï¸ AWR coleta automaticamente dados de desempenho em intervalos regulares
â–¶ï¸ O AWR armazena informaÃ§Ãµes sobre a atividade do sistema, sessÃµes de banco de dados e eventos de espera.
â–¶ï¸ Utiliza snapshots, que sÃ£o amostras dos dados de desempenho coletadas em intervalos de tempo especÃ­ficos
âš ï¸ Ã‰ uma Extra Option, porÃ©m quando vocÃª instala o Oracle habilita este recurso por default (pegadinha da Oracle)


=================================================================
== ğŸ¯ Quando utilizar o AWR
=================================================================
â–¶ï¸ Quando Ã© necessÃ¡rio analisar o que ocorreu no passado, mesmo que esse passado seja recente 
â–¶ï¸ Por exemplo, Ã s 09h00 da manhÃ£ vocÃª pode analisar o que ocorreu entre 06:00 e 07:00


=================================================================
== ğŸ¯ BenefÃ­cios do AWR
=================================================================
âœ… Coleta Automatizada de Dados
âœ… Dados HistÃ³ricos
âœ… IdentificaÃ§Ã£o de Gargalos
âœ… RelatÃ³rios AWR
âœ… RelatÃ³rios Comparativos
âœ… DefiniÃ§Ã£o de Baselines
âœ… AnÃ¡lise de TendÃªncias
âœ… IntegraÃ§Ã£o com ADDM




=================================================================
== ğŸ¯ ConfiguraÃ§Ãµes do AWR
=================================================================
â–¶ï¸ Quando vocÃª cria um database no Oracle EE, ele jÃ¡ configura o AWR
â–¶ï¸ Ele executa um snapshot a cada hora e mantÃ©m as informaÃ§Ãµes por 8 dias 
â–¶ï¸ O parÃ¢mentro STATISTICS_LEVEL define o comportamento do AWR:
	â–«ï¸ TYPICAL: Coleta todas as estatÃ­sticas necessÃ¡rias, Ã© o padrÃ£o. 
	â–«ï¸ BASIC: Desativa o AWR
	â–«ï¸ ALL: Coleta estatÃ­sticas de forma detalhada, sÃ³ habilite se souber o que estiver fazendo


SQL> select
       extract( day from snap_interval) *24*60+
       extract( hour from snap_interval) *60+
       extract( minute from snap_interval ) "Snapshot Interval",
       (extract( day from retention) *24*60+
       extract( hour from retention) *60+
       extract( minute from retention ))/60/24 "Retention Interval (Days)"
from dba_hist_wr_control;

=================================================================
== ğŸ¯ Modificando as configuraÃ§Ãµes do AWR
=================================================================
-- 30 dias a cada 30 minutos
SQL> execute dbms_workload_repository.modify_snapshot_settings(interval => 15,retention => 86400); 


=================================================================
== ğŸ¯ Verificando os snapshots criados
=================================================================
SQL> SELECT 
SNAP_ID
, to_char(BEGIN_INTERVAL_TIME,'DD/MM/RRRR HH24:MI') BEGIN_INTERVAL_TIME
, to_char(END_INTERVAL_TIME,'DD/MM/RRRR HH24:MI')  END_INTERVAL_TIME
FROM DBA_HIST_SNAPSHOT 
ORDER BY SNAP_ID  desc
FETCH FIRST 5 ROWS ONLY;


=================================================================
== ğŸ¯ Criando um snapshot manualmente
=================================================================
SQL> EXECUTE DBMS_WORKLOAD_REPOSITORY.CREATE_SNAPSHOT;



=================================================================
== ğŸ¯ Excluindo snapshots
=================================================================
SQL> EXECUTE DBMS_WORKLOAD_REPOSITORY.DROP_SNAPSHOT_RANGE(low_snap_id  => 698, high_snap_id => 699);



=================================================================
== ğŸ¯ Criando uma baseline
=================================================================
â–¶ï¸ Uma baseline Ã© um perÃ­odo que vocÃª considera bom para comparar a performance
â–¶ï¸ Os snapshots da baseline vÃ£o ser mantidos, independentemente da janela

SQL> EXECUTE DBMS_WORKLOAD_REPOSITORY.CREATE_BASELINE(start_snap_id=>700,end_snap_id=>701,baseline_name=>'good_load2');

=================================================================
== ğŸ¯ Scripts para gerar relatÃ³rios AWR
=================================================================
â–¶ï¸ Tem vÃ¡rios scripts que geram relatÃ³rio AWR, cada um com uma finalidade diferente
â–¶ï¸ Os scripts ficam no servidor, no diretÃ³rio @$ORACLE_HOME/rdbms/admin/
â–¶ï¸ Gera um arquivo no formato html ou texto
â–¶ï¸ TambÃ©m podem ser gerado atravÃ©s de procedures
â–¶ï¸ Abaixo os principais relatÃ³rios:
	â–«ï¸ awrrpt.sql		Gera o relatÃ³rio AWR para ambientes Single Instance
	â–«ï¸ awrgrpt.sql		Gera o relatÃ³rio AWR para ambientes RAC
	â–«ï¸ awrddrpt.sql	Gera o relatÃ³rio AWR comparando dois perÃ­odos do tempo

ter 09:00 - 10:00 (nesse perÃ­odo ficou lento)



comparar a terca atual 09:00 as 10:00 com a segunda da dia anterior

=================================================================
== ğŸ¯ Gerando relatÃ³rios AWR
=================================================================
$ . oraenv
$ sqlplus / as sysdba

SQL> @$ORACLE_HOME/rdbms/admin/awrrpt.sql
SQL> @$ORACLE_HOME/rdbms/admin/awrgrpt.sql
SQL> @$ORACLE_HOME/rdbms/admin/awrddrpt.sql


=================================================================
== ğŸ¯ ConclusÃ£o
=================================================================
ğŸ’¡ Ã‰ um Ã³timo recurso para se analisar problemas de performance
ğŸ’¡ Normalmente Ã© utilizado quando queremos olhar para o passado
ğŸ’¡ Fornece uma infinidade de informaÃ§Ãµes, nÃ£o tente aprender tudo de uma vez, evolua aos poucos 