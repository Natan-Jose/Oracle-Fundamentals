|-------------------------------------------------------------------------------|
| Aula      : Deadlocks															|
| MÃ³dulo    : IntroducÌ§aÌƒo a performance e tuning                                 |
| Curso     : Oracle Fundamentals                                               |
| Instrutor : Marcio Mandarino                                                  |
| URL       : mrdba.com.br/oracle_fundamentals                                  |
|-------------------------------------------------------------------------------|
| ReferÃªncia: https://docs.oracle.com/en/database/oracle/oracle-database/19/cncpt/data-concurrency-and-consistency.html#GUID-C1971E9B-849A-4634-9575-4F8FAD697750
|-------------------------------------------------------------------------------|


=================================================================
== ğŸ¯ Objetivos da Aula:
=================================================================
ğŸ’¡ Entender como funciona um Deadlock no Oracle
ğŸ’¡ Saber monitorar e identificar deadlocks 
ğŸ’¡ Boas prÃ¡ticas para lidar com deadlocks


=================================================================
== ğŸ¯ Resumo
=================================================================
ğŸ“ Conceito geral
ğŸ“ Causas comuns 
ğŸ“ Gerando um deadlock 
ğŸ“ ConsequÃªncias
ğŸ“ Como evitar
ğŸ“ ConclusÃ£o


=================================================================
== ğŸ¯ Conceito geral
=================================================================
â–¶ï¸ SÃ£o situaÃ§Ãµes em que duas ou mais transaÃ§Ãµes entram em um estado de espera infinita, esperando uma pela outra para liberar os recursos necessÃ¡rios para continuar
â–¶ï¸ No Oracle Database, o processo de detecÃ§Ã£o de deadlocks Ã© automÃ¡tico e quando um deadlock Ã© identificado, uma das transaÃ§Ãµes envolvidas Ã© escolhida como â€œvÃ­timaâ€ e um rollback Ã© emitido para liberÃ¡-la
â–¶ï¸ Por ter uma resoluÃ§Ã£o automÃ¡tica, teoricamente o DBA nÃ£o tem aÃ§Ã£o
â–¶ï¸ Essa Ã© uma questÃ£o de design de aplicaÃ§Ã£o, nÃ£o Ã© um problema de banco de dados
â–¶ï¸ O DBA deve apoiar na identificaÃ§Ã£o e sugestÃ£o de boas prÃ¡ticas para resolver problemas de deadlock

=================================================================
== ğŸ¯ Causas comuns 
=================================================================
â–¶ï¸ ConcorrÃªncia entre transaÃ§Ãµes: Duas ou mais transaÃ§Ãµes tentando acessar os mesmos recursos em ordens diferentes.
â–¶ï¸ OperaÃ§Ãµes complexas e longas: TransaÃ§Ãµes que mantÃªm locks por longos perÃ­odos aumentam a chance de deadlocks.
â–¶ï¸ MÃ¡ ordenaÃ§Ã£o de acessos: TransaÃ§Ãµes que acessam recursos em ordens inconsistentes.


=================================================================
== ğŸ¯ Gerando um deadlock 
=================================================================
â–¶ï¸ Abra 3 sessÃµes:

-- Criando estrutura para o teste
SQL> CREATE TABLE tb_deadlock (id NUMBER);
SQL> INSERT INTO tb_deadlock VALUES ( 1 );
SQL> INSERT INTO tb_deadlock VALUES ( 2 );
SQL> commit;
SQL> exit
$ adrci
adrci> show homes
adrci> set home diag/rdbms/orcl/orcl
adrci> show alert -tail -f



-- SessÃ£o 1
SQL> set timing on
SQL> DELETE tb_deadlock WHERE id = 1;

-- SessÃ£o 2
SQL> set timing on
SQL> DELETE tb_deadlock WHERE id = 2;


-- SessÃ£o 1
SQL> DELETE tb_deadlock WHERE id = 2;

-- SessÃ£o 2
SQL> DELETE tb_deadlock WHERE id = 1;


=================================================================
== ğŸ¯ ConsequÃªncias
=================================================================
â–¶ï¸ Um das transaÃ§Ãµes receberÃ¡ o erro ORA-00060: Deadlock detected
â–¶ï¸ A sessÃ£o continua viva. A transaÃ§Ã£o que Ã© finalizada
â–¶ï¸ SerÃ¡ escrito no alert do banco a ocorrÃªncia do deadlock
â–¶ï¸ Um arquivo de trace serÃ¡ gerado
â–¶ï¸ Deadlocks geram eventos de espera de "enq: TX - row lock contention"

=================================================================
== ğŸ¯ Como evitar
=================================================================
â–¶ï¸ TransaÃ§Ãµes Curtas: Mantenha as transaÃ§Ãµes o mais curtas possÃ­vel para reduzir a janela de tempo onde deadlocks podem ocorrer
â–¶ï¸ ConsistÃªncia na Ordem de Acesso: Acesse os recursos na mesma ordem em todas as transaÃ§Ãµes
â–¶ï¸ Isolamento de TransaÃ§Ãµes: Use nÃ­veis de isolamento apropriados para minimizar a contenÃ§Ã£o de recursos
â–¶ï¸ Monitoramento Regular: Utilize ferramentas de monitoramento para identificar e resolver padrÃµes que podem levar a deadlocks


=================================================================
== ğŸ¯ ConclusÃ£o
=================================================================
ğŸ’¡ A culpa do Deadlock nÃ£o Ã© do banco, porÃ©m muitas vezes o DBA Ã© culpado
ğŸ’¡ Entenda como funciona o Deadlock para demonstrar que o problema Ã© na aplicaÃ§Ã£o
ğŸ’¡ Simule o processo de deadlock
ğŸ’¡ Deadlocks nÃ£o Ã© algo saudÃ¡vel para o banco, procure sempre solucionÃ¡-los

 