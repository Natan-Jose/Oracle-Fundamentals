|-------------------------------------------------------------------------------|
| Aula      : O banco de dados est√° lento!										|
| M√≥dulo    : IntroducÃßaÃÉo a performance e tuning                                 |
| Curso     : Oracle Fundamentals                                               |
| Instrutor : Marcio Mandarino                                                  |
| URL       : mrdba.com.br/oracle_fundamentals                                  |
|-------------------------------------------------------------------------------|
| Refer√™ncia: 
|-------------------------------------------------------------------------------|


=================================================================
== üéØ Objetivos da Aula:
=================================================================
üí° Saber fazer um troubleshooting de performance no Oracle


=================================================================
== üéØ Resumo
=================================================================
üìç Conceito geral
üìç Quest√µes importantes
üìç Arsenal de ferramentas
üìç An√°lise Top Down
üìç Executar uma carga
üìç An√°lise de SO
üìç An√°lise Real Time do Dabase (oratop)
üìç Waits do banco
üìç Capturando o SQL 
üìç Analisando o SQL
üìç Recomenda√ß√µes
üìç Colete todas as informa√ß√µes e gere uma resposta
üìç Conclus√£o

=================================================================
== üéØ Conceito geral
=================================================================
‚ñ∂Ô∏è Nem sempre o problema √© no banco (na maioria das vezes n√£o √©)
‚ñ∂Ô∏è O usu√°rio reporta lentid√£o no sistema, mas o problema pode estar em v√°rios lugares
	‚ñ´Ô∏è https://docs.oracle.com/en/database/oracle/oracle-database/19/tdppt/img/tdppt001.gif
‚ñ∂Ô∏è Por√©m, temos que provar que o problema n√£o est√° no banco
‚ñ∂Ô∏è Ou chegarmos a conclus√£o que o problema est√° no banco
‚ñ∂Ô∏è Uma coisa √© o problema estar no banco, outra coisa √© o problema ser o banco

=================================================================
== üéØ Quest√µes importantes
=================================================================
‚ñ∂Ô∏è Fazer um levantamento b√°sico com quem reportou o problema
‚ñ∂Ô∏è Esse levantamento vai definir o "horizonte" da sua an√°lise
	‚ñ´Ô∏è A lentid√£o ainda est√° ocorrendo ou j√° passou? 
	‚ñ´Ô∏è Se passou, quando terminou? Quando come√ßou?
	‚ñ´Ô∏è Qual a percep√ß√£o de lentid√£o? Geral ou em alguns processos espec√≠ficos? 


=================================================================
== üéØ Arsenal de ferramentas
=================================================================
‚ñ∂Ô∏è J√° temos ferramentas o suficiente para identificar um problema de performance
	‚ñ´Ô∏è comando top do linux
	‚ñ´Ô∏è comando oratop do Oracle
	‚ñ´Ô∏è Scripts personalizados
		üí° @quem
		üí° @quem2
		üí° @s
		üí° @aas 
		üí° @ash
		üí° ash2
		üí° ash3
		üí° @sql_id
		üí° @adv_sql
		üí° @addm
		üí° @addm_detail
		üí° @addm_report
	‚ñ´Ô∏è AWR
	‚ñ´Ô∏è ADDM	
	‚ñ´Ô∏è Ferramentas adicionais fornecidas pela empresa	


=================================================================
== üéØ An√°lise Top Down
=================================================================
‚ñ∂Ô∏è Comece analisar de "Cima para baixo"
‚ñ∂Ô∏è Veja os aspectos b√°sicos de SO: CPU, mem√≥ria, swap, etc.
‚ñ∂Ô∏è Analise as esperas do banco
	‚ñ´Ô∏è AAS
	‚ñ´Ô∏è Wait Class
 	‚ñ´Ô∏è Events
‚ñ∂Ô∏è Identifique os sql_ids mais ofensores do ambiente
‚ñ∂Ô∏è Identifique de onde est√° gerando a alta carga
	‚ñ´Ô∏è Top users
	‚ñ´Ô∏è Top Programs
	‚ñ´Ô∏è Top Machines
‚ñ∂Ô∏è Report os problemas identificados


=================================================================
== üéØ Executar uma carga
=================================================================
-- Sess√£o 1: Rodar o swingbench como root
# cd /u01/swingbenchlatest/swingbench/bin/
# ./charbench -uc 10 -cs //localhost/orcl -c ../configs/SOE_Server_Side_V2.xml -u SOE -p SOE -parallel 2


=================================================================
== üéØ An√°lise de SO
=================================================================
$ top
$ free -m

=================================================================
== üéØ An√°lise Real Time do Dabase (oratop)
=================================================================
$ cd $ORACLE_HOME/suptools/oratop/
$ ./oratop -rf / as sysdba


=================================================================
== üéØ Waits do banco
=================================================================
SQL> @aas 15
SQL> @ash 15

=================================================================
== üéØ Capturando o SQL 
=================================================================
SQL> @ash3 sql_id session_type='FOREGROUND' 3

SQL> @ash3 machine "sql_id='f7rxuxzt64k87'" 4
SQL> @ash3 program "sql_id='f7rxuxzt64k87'" 4
SQL> @ash3 username "sql_id='f7rxuxzt64k87'" 4

=================================================================
== üéØ Analisando o SQL 
=================================================================
SQL> @sql_id f7rxuxzt64k87
SQL> @adv_sql f7rxuxzt64k87


=================================================================
== üéØ Recomenda√ß√µes 
=================================================================
SQL> EXECUTE DBMS_WORKLOAD_REPOSITORY.CREATE_SNAPSHOT;
SQL> @addm_report


=================================================================
== üéØ Colete todas as informa√ß√µes e gere uma resposta
=================================================================
Ex. 

Durante o per√≠odo de an√°lise idenficadas as seguintes quest√µes:
- Um alto volume de load no banco de dados a partir de 2024-07-04 11:40:28
- O usu√°rio SOE foi respons√°vel por 77% do load do banco no per√≠odo.
- Os maiores eventos de espera no banco foram: 

EVENT                          TOTAL_WAIT_TIME %This
------------------------------ --------------- --------------------
ON CPU                                    3138   30%
log file sync                             1777   17%
db file sequential read                   1388   13%
free buffer waits                          949    9%
db file async I/O submit                   872    8%

- A query c13sma6rkr27c foi respons√°vel pelo maior load do banco (15% do load do per√≠odo)
SQL_ID c13sma6rkr27c
--------------------
SELECT PRODUCTS.PRODUCT_ID, PRODUCT_NAME, PRODUCT_DESCRIPTION,
CATEGORY_ID, WEIGHT_CLASS, WARRANTY_PERIOD, SUPPLIER_ID,
PRODUCT_STATUS, LIST_PRICE, MIN_PRICE, CATALOG_URL, QUANTITY_ON_HAND
FROM PRODUCTS, INVENTORIES WHERE PRODUCTS.CATEGORY_ID = :B3 AND
INVENTORIES.PRODUCT_ID = PRODUCTS.PRODUCT_ID AND
INVENTORIES.WAREHOUSE_ID = :B2 AND ROWNUM < :B1

Plan hash value: 3615835943

-------------------------------------------------------------------------------------------------------
| Id  | Operation                      | Name                 | Rows  | Bytes | Cost (%CPU)| Time     |
-------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT               |                      |       |       |    40 (100)|          |
|   1 |  COUNT STOPKEY                 |                      |       |       |            |          |
|   2 |   HASH JOIN OUTER              |                      |    10 |  4100 |    40   (0)| 00:00:01 |
|   3 |    NESTED LOOPS                |                      |    10 |  1930 |    29   (0)| 00:00:01 |
|   4 |     NESTED LOOPS               |                      |    10 |  1930 |    29   (0)| 00:00:01 |
|   5 |      TABLE ACCESS FULL         | PRODUCT_INFORMATION  |    10 |  1790 |     9   (0)| 00:00:01 |
|   6 |      INDEX UNIQUE SCAN         | INVENTORY_PK         |     1 |       |     1   (0)| 00:00:01 |
|   7 |     TABLE ACCESS BY INDEX ROWID| INVENTORIES          |     1 |    14 |     2   (0)| 00:00:01 |
|   8 |    TABLE ACCESS FULL           | PRODUCT_DESCRIPTIONS |  1000 |   211K|    11   (0)| 00:00:01 |
-------------------------------------------------------------------------------------------------------


=================================================================
== üéØ Conclus√£o
=================================================================
üí° A pr√°tica leva a perfei√ß√£o
üí° Essa √© uma boa an√°lise, por√©m com o tempo voc√™ vai melhor√°-la
üí° Sempre que poss√≠vel, forne√ßa recomenda√ß√µes
üí° Repita os exerc√≠cios dessa aula
üí° Tenha dom√≠nio sobre os scripts apresentados nesse m√≥dulo, eles ser√£o sua caixa de ferramentas!
 