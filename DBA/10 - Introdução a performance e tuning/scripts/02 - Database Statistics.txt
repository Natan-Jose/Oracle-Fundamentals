|-------------------------------------------------------------------------------|
| Aula      : Database Statistics												|
| MÃ³dulo    : IntroducÌ§aÌƒo a performance e tuning                                 |
| Curso     : Oracle Fundamentals                                               |
| Instrutor : Marcio Mandarino                                                  |
| URL       : mrdba.com.br/oracle_fundamentals                                  |
|-------------------------------------------------------------------------------|
| ReferÃªncia: https://docs.oracle.com/en/database/oracle/oracle-database/19/tdppt/oracle-database-performance-method.html#GUID-8DEA5079-6AAB-47D8-857A-9B5301843290
|-------------------------------------------------------------------------------|


=================================================================
== ðŸŽ¯ Objetivos da Aula:
=================================================================
ðŸ’¡ Compreender a base de como se analisar a performance do Oracle


=================================================================
== ðŸŽ¯ Resumo
=================================================================
ðŸ“ Conceito geral
ðŸ“ Database Time
ðŸ“ User Response Time
ðŸ“ Wait Event Statistics
ðŸ“ Exemplo prÃ¡tico 1
ðŸ“ Exemplo prÃ¡tico 2
ðŸ“ Sripts Ãºteis
ðŸ“ ConclusÃ£o


=================================================================
== ðŸŽ¯ Conceito geral
=================================================================
â–¶ï¸ Time model statistics Ã© o tempo gasto pelo banco de dados para realizar um tipo de atividade
â–¶ï¸ A estatÃ­stica mais importante Ã© o Database Time (DB Time)


=================================================================
== ðŸŽ¯ Database Time
=================================================================
â–¶ï¸ DB Time representa o tempo total gasto pelo banco de dados em execuÃ§Ãµes de processos de Foreground (Processos do usuÃ¡rio)
â–¶ï¸ O DB Time Ã© um indicador do total do workload do banco de dados
	â–«ï¸ DB time considera apenas o tempo gasto por processos do usuÃ¡rio
â–¶ï¸ O CPU time representa a soma do tempo de execuÃ§Ã£o para cada requisiÃ§Ã£o no banco de dados
â–¶ï¸ O Wait Time Ã© a soma de todas as atividades de espera da instÃ¢ncia por recursos

https://docs.oracle.com/en/database/oracle/oracle-database/19/tdppt/img/tdppt001.gif





=================================================================
== ðŸŽ¯ User Response Time
=================================================================
â–¶ï¸ Uma sessÃ£o Ã© uma entidade lÃ³gica na memÃ³ria da instÃ¢ncia que representa o estado de um login de usuÃ¡rio no database
â–¶ï¸ O Database time Ã© calculado somando o tempo de CPU e os tempos de espera para todas as sessÃµes ativas (que nÃ£o estÃ£o em Idle)

https://docs.oracle.com/en/database/oracle/oracle-database/19/tdppt/img/tdppt003.gif


=================================================================
== ðŸŽ¯ Wait Event Statistics
=================================================================
â–¶ï¸ Wait Events sÃ£o incrementados por uma sessÃ£o indicando que essa sessÃ£o precisou esperar por algum evento ser completado antes de continuar o processamento.
â–¶ï¸ Quando uma sessÃ£o aguarda o processamento de uma requisiÃ§Ã£o do usuÃ¡rio, o database registra essas esperas em um conjunto de waits events predefinidos.
â–¶ï¸ Esses waits events sÃ£o agrupados em Wait Class:
	â–«ï¸ Administrative 
	â–«ï¸ Application
	â–«ï¸ Cluster
	â–«ï¸ Commit
	â–«ï¸ Concurrency
	â–«ï¸ Configuration
	â–«ï¸ Idle
	â–«ï¸ Network
	â–«ï¸ Other
	â–«ï¸ Queueing
	â–«ï¸ Scheduler
	â–«ï¸ System I/O
	â–«ï¸ User I/O


=================================================================
== ðŸŽ¯ Exemplo prÃ¡tico 1
=================================================================
$ . oraenv
ORACLE_SID = [orcl] ? orcl

$ sqlplus / as sysdba

SQL> drop TABLE random_data;

SQL> CREATE TABLE random_data (
    id NUMBER ,
    random_value NUMBER
);

SQL> DECLARE
v_start NUMBER := 1;
v_end NUMBER := 2000000;
v_random_value NUMBER;
BEGIN
DBMS_APPLICATION_INFO.set_action(action_name => 'test_load');
FOR i IN v_start..v_end LOOP
    v_random_value := DBMS_RANDOM.VALUE(1, 1000000);
    INSERT INTO random_data (id, random_value) VALUES (i, v_random_value);
    
    -- Commit every 10,000 records to avoid too much undo data
    IF MOD(i, 10000) = 0 THEN
        COMMIT;
    END IF;
END LOOP;

-- Final commit
COMMIT;
END;
/

-- Monitorar no Sql Developer
SQL> SELECT
    sid,
    serial#,
    username,
    status,
    osuser,
    machine,
    program,
    type,
    last_call_et,
    event,
    wait_class,
    wait_time,
    state
FROM
    v$session
WHERE
    action = 'test_load';    
    

SQL> SELECT
    sample_time,
    sql_id,
    sql_opname,
    sql_plan_hash_value,
    sql_plan_operation,
    sql_plan_options,
    event,
    wait_class,
    wait_time,
    session_state
FROM
    v$active_session_history
        WHERE action = 'test_load' order by sample_time desc;

=================================================================
== ðŸŽ¯ Exemplo prÃ¡tico 2
=================================================================
# cd /u01/swingbenchlatest/swingbench/bin/
# ./charbench -uc 10 -cs //localhost/orcl -c ../configs/SOE_Server_Side_V2.xml -u SOE -p SOE -parallel 2



SQL> SELECT
    sample_time,
    sql_id,
    sql_opname,
    sql_plan_hash_value,
    sql_plan_operation,
    sql_plan_options,
    event,
    wait_class,
    wait_time,
    session_state
FROM
    v$active_session_history
        WHERE program = 'JDBC Thin Client' order by sample_time desc;


=================================================================
== ðŸŽ¯ Sripts Ãºteis
=================================================================
ðŸ’¡ @quem
ðŸ’¡ @quem2
ðŸ’¡ @s
ðŸ’¡ @ash (New)
ðŸ’¡ ash2 (New)
ðŸ’¡ @sql_id (New)

=================================================================
== ðŸŽ¯ ConclusÃ£o
=================================================================
ðŸ’¡ Compreender esses aspectos teÃ³ricos Ã© estratÃ©gico para fazer tuning no banco

 