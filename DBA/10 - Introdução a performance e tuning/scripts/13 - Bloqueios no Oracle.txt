|-------------------------------------------------------------------------------|
| Aula      : Bloqueios no Oracle																								|
| MÃ³dulo    : IntroducÌ§aÌƒo a performance e tuning                                 |
| Curso     : Oracle Fundamentals                                               |
| Instrutor : Marcio Mandarino                                                  |
| URL       : mrdba.com.br/oracle_fundamentals                                  |
|-------------------------------------------------------------------------------|
| ReferÃªncia: https://docs.oracle.com/en/database/oracle/oracle-database/19/cncpt/data-concurrency-and-consistency.html#GUID-AD0CEE83-2F33-4906-94E1-3D1022924C63
|-------------------------------------------------------------------------------|



=================================================================
== ğŸ¯ Objetivos da Aula:
=================================================================
ğŸ’¡ Aprender sobre bloqueios no Oracle
ğŸ’¡ Saber como lidar com os bloqueios



=================================================================
== ğŸ¯ Resumo
=================================================================
ğŸ“ Conceito geral
ğŸ“ PropÃ³sito do Mecanismo de Bloqueio
ğŸ“ Quem Ã© o culpado? 
ğŸ“ Tipos de Bloqueio no Oracle
ğŸ“ Simulando um bloqueio exclusivo
ğŸ“ Identificando bloqueios
ğŸ“ AÃ§Ãµes do DBA
ğŸ“ Boas prÃ¡ticas para o DBA
ğŸ“ ConclusÃ£o

=================================================================
== ğŸ¯ Conceito geral
=================================================================
â–¶ï¸ O Oracle utiliza mecanismos de bloqueio para garantir a consistÃªncia e a integridade dos dados
â–¶ï¸ O mecanismo de bloqueio Ã© crucial para garantir que transaÃ§Ãµes concorrentes mantenham a consistÃªncia dos dados durante operaÃ§Ãµes de leitura e gravaÃ§Ã£o
â–¶ï¸ Ã‰ comum ter bloqueios, porÃ©m nÃ£o Ã© bom ter bloqueios longos
â–¶ï¸ Ficar identificando problemas de bloqueio no banco Ã© algo muito comum no dia a dia do DBA
âš ï¸ Ã‰ muito comum, aplicaÃ§Ãµes inteiras ficarem indisponÃ­veis devido a problemas de bloqueio


=================================================================
== ğŸ¯ PropÃ³sito do Mecanismo de Bloqueio
=================================================================
â–¶ï¸ Garantia de ConsistÃªncia dos Dados
	â–«ï¸ O mecanismo de bloqueio Ã© essencial para garantir que operaÃ§Ãµes de leitura e gravaÃ§Ã£o mantenham a consistÃªncia dos dados.
	â–«ï¸ Evita que diferentes transaÃ§Ãµes acessem e modifiquem os mesmos dados simultaneamente, 
	   o que poderia levar a resultados inconsistentes ou corrompidos.
â–¶ï¸ Controle de Acesso Concorrente
	â–«ï¸ Permite que vÃ¡rias transaÃ§Ãµes sejam executadas simultaneamente, desde que nÃ£o interfiram umas com as outras.
	â–«ï¸ Gerencia eficientemente o acesso concorrente, mantendo a integridade dos dados.


=================================================================
== ğŸ¯ Quem Ã© o culpado? 
=================================================================
â–¶ï¸ Muitas vezes, o problema Ã© atribuÃ­do ao banco de dados
â–¶ï¸ Na maioria das vezes, o problema estÃ¡ na aplicaÃ§Ã£o
â–¶ï¸ Em alguns casos, pode ser no banco, devido a problemas de lentidÃ£o


=================================================================
== ğŸ¯ Tipos de Bloqueio no Oracle
=================================================================
â–¶ï¸ Bloqueio Exclusivo (Exclusive Lock)
	â–«ï¸ Bloqueia um recurso para uma transaÃ§Ã£o especÃ­fica, impedindo que outras transaÃ§Ãµes o acessem atÃ© que o bloqueio seja liberado.
	â–«ï¸ Utilizado durante operaÃ§Ãµes de atualizaÃ§Ã£o, como INSERT, UPDATE ou DELETE.
â–¶ï¸ Bloqueio Compartilhado (Share Lock)
	â–«ï¸ Permite que vÃ¡rias transaÃ§Ãµes acessem um recurso simultaneamente para leitura.
	â–«ï¸ NÃ£o impede outros acessos de leitura, mas evita que transaÃ§Ãµes faÃ§am alteraÃ§Ãµes no recurso bloqueado.


=================================================================
== ğŸ¯ Simulando um bloqueio exclusivo
=================================================================
create table dept(   
  deptno     number(2,0),   
  dname      varchar2(14),   
  loc        varchar2(13),   
  constraint pk_dept primary key (deptno)   
);

create table emp(   
  empno    number(4,0),   
  ename    varchar2(10),   
  job      varchar2(9),   
  mgr      number(4,0),   
  hiredate date,   
  sal      number(7,2),   
  comm     number(7,2),   
  deptno   number(2,0),   
  constraint pk_emp primary key (empno),   
  constraint fk_deptno foreign key (deptno) references dept (deptno)   
);

insert into dept values(10, 'ACCOUNTING'	, 'NEW YORK');
insert into dept values(20, 'RESEARCH'		, 'DALLAS');
insert into dept values(30, 'SALES'			  , 'CHICAGO');
insert into dept values(40, 'OPERATIONS'	, 'BOSTON');

INSERT INTO emp VALUES (7839,'KING',   'PRESIDENT',NULL, TO_DATE('17-11-1981'	, 'dd-mm-yyyy'),    5000,    NULL,   10);
INSERT INTO emp VALUES (7698,'BLAKE',  'MANAGER',  7839, TO_DATE('1-5-1981'		, 'dd-mm-yyyy'),    2850,    NULL,   30);
INSERT INTO emp VALUES (7782,'CLARK',  'MANAGER',  7839, TO_DATE('9-6-1981'		, 'dd-mm-yyyy'),    2450,    NULL,   10);
INSERT INTO emp VALUES (7566,'JONES',  'MANAGER',  7839, TO_DATE('2-4-1981'		, 'dd-mm-yyyy'),    2975,    NULL,   20);
INSERT INTO emp VALUES (7788,'SCOTT',  'ANALYST',  7566, TO_DATE('13-JUL-87'	, 'dd-mm-rr') - 85, 3000,    NULL,   20);
INSERT INTO emp VALUES (7902,'FORD',   'ANALYST',  7566, TO_DATE('3-12-1981'	, 'dd-mm-yyyy'),    3000,    NULL,   20);
INSERT INTO emp VALUES (7369,'SMITH',  'CLERK',    7902, TO_DATE('17-12-1980'	, 'dd-mm-yyyy'),    800,     NULL,   20);
INSERT INTO emp VALUES (7499,'ALLEN',  'SALESMAN', 7698, TO_DATE('20-2-1981'	, 'dd-mm-yyyy'),    1600,    300,    30);
INSERT INTO emp VALUES (7521,'WARD',   'SALESMAN', 7698, TO_DATE('22-2-1981'	, 'dd-mm-yyyy'),    1250,    500,    30);
INSERT INTO emp VALUES (7654,'MARTIN', 'SALESMAN', 7698, TO_DATE('28-9-1981'	, 'dd-mm-yyyy'),    1250,    1400,   30);
INSERT INTO emp VALUES (7844,'TURNER', 'SALESMAN', 7698, TO_DATE('8-9-1981'		, 'dd-mm-yyyy'),    1500,    0,      30);
INSERT INTO emp VALUES (7876,'ADAMS',  'CLERK',    7788, TO_DATE('13-JUL-87'	, 'dd-mm-rr') - 51, 1100,    NULL,   20);
INSERT INTO emp VALUES (7900,'JAMES',  'CLERK',    7698, TO_DATE('3-12-1981'	, 'dd-mm-yyyy'),    950,     NULL,   30);
INSERT INTO emp VALUES (7934,'MILLER', 'CLERK',    7782, TO_DATE('23-1-1982'	, 'dd-mm-yyyy'),    1300,    NULL,   10);
COMMIT;





-- SessÃ£o 1
SQL> UPDATE emp 
  SET sal = sal*1.1
  WHERE empno = 7839;

-- SessÃ£o 2
SQL> UPDATE emp 
  SET sal = sal*1.2
  WHERE empno = 7839;


âš ï¸ A sessÃ£o 1 gerou um bloqueio exclusivo na linha com employee_id = 100
âš ï¸ A sessÃ£o 2 irÃ¡ aguardar atÃ© que o bloqueio da sessÃ£o termine
âš ï¸ A sessÃ£o 1 irÃ¡ terminar sob os seguintes cenÃ¡rios:
	â˜‘ï¸ Efetuar o commit/rollback
	â˜‘ï¸ Ter a sessÃ£o finalizada (que irÃ¡ submeter a sessÃ£o a rollback)
âš ï¸ Nada impede que uma terceira sessÃ£o faÃ§a consulta na coluna com bloqueio exclusivo
	SQL> SELECT salary
	FROM HR.employees
	WHERE employee_id = 100;

=================================================================
== ğŸ¯ Identificando bloqueios
=================================================================
â–¶ï¸ Existem algumas views no dicionÃ¡rio de dados que nos auxiliam nessa identificaÃ§Ã£o:
	â–«ï¸ V$SESSION
	â–«ï¸ DBA_WAITERS
	â–«ï¸ V$LOCKED_OBJECT
	â–«ï¸ V$LOCK

SQL> col username form a10
SQL> col osuser form a10
SQL> col program form a43
SQL> col event form a30
SQL> SELECT sid, serial#, status,username,osuser,program,blocking_session blocking,event
FROM v$session
WHERE blocking_session IS NOT NULL;

â–¶ï¸ No prÃ³prio servidor tem um script interessante chamado utllockt.sql

SQL> set lines 200
SQL> @$ORACLE_HOME/rdbms/admin/utllockt.sql


â–¶ï¸ Script @lock



=================================================================
== ğŸ¯ AÃ§Ãµes do DBA
=================================================================
â–¶ï¸ O DBA sÃ³ pode fazer duas coisas para resolver esse tipo de bloqueio:
	â–«ï¸ Esperar ele finalizar
	â–«ï¸ Dar um Kill na sessÃ£o bloqueadora
âš ï¸ NÃ£o saia finalizando sessÃµes bloqueadoras sem notificar ninguÃ©m!
ğŸ’¡ Identifique o bloqueio e notifique os responsÃ¡veis pela aplicaÃ§Ã£o.
	â–«ï¸ Mande o mÃ¡ximo de evidÃªncias
	â–«ï¸ Seja rÃ¡pido
	â–«ï¸ Caso haja autorizaÃ§Ã£o, finalize a sessÃ£o

SQL> @s SID SERIAL#



=================================================================
== ğŸ¯ Boas prÃ¡ticas para o DBA
=================================================================
ğŸ’¡ Bloqueios sÃ£o inevitÃ¡vies, aprenda a lidar com eles
ğŸ’¡ NÃ£o seja um finalizador de bloqueios
ğŸ’¡ Tenha scripts eficientes para identificar bloqueios
ğŸ’¡ Monitore bloqueios de forma proativa
ğŸ’¡ Fique atento aos eventos de espera de "enq: TX - row lock contention"




=================================================================
== ğŸ¯ ConclusÃ£o
=================================================================
ğŸ’¡ Essa Ã© uma atividade muito comum no dia a dia do DBA, tenha domÃ­nio sobre ela!
ğŸ’¡ Pratique os cenÃ¡rios descritos na aula!
ğŸ’¡ Seja rÃ¡pido e eficiente

 