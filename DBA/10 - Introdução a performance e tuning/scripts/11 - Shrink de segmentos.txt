|-------------------------------------------------------------------------------|
| Aula      : Shrink de segmentos											    |
| M√≥dulo    : IntroducÃßaÃÉo a performance e tuning                                 |
| Curso     : Oracle Fundamentals                                               |
| Instrutor : Marcio Mandarino                                                  |
| URL       : mrdba.com.br/oracle_fundamentals                                  |
|-------------------------------------------------------------------------------|
| Refer√™ncia: https://docs.oracle.com/en/database/oracle/oracle-database/19/admin/managing-tables.html#GUID-D4AE1CF2-08F7-4AB2-9317-0DE20AC70D44
|-------------------------------------------------------------------------------|


=================================================================
== üéØ Objetivos da Aula:
=================================================================
üí° Aprender a identificar e realizar o shrink de segmentos


=================================================================
== üéØ Resumo
=================================================================
üìç Conceito geral
üìç O que s√£o dados fragmentados?
üìç Chained Rows
üìç Upgraded Rows
üìç Quais os principais motivos de fazermos a manuten√ß√£o de segmentos
üìç Meios de realizar a manuten√ß√£o dos segmentos
üìç Criando cen√°rio de fragmenta√ß√£o
üìç Detectando a fragmenta√ß√£o
üìç Resolvendo o problema de fragmenta√ß√£o
üìç Analisando a tablespace inteira
üìç Conclus√£o


=================================================================
== üéØ Conceito geral
=================================================================
‚ñ∂Ô∏è √â uma atividade t√≠pica do DBA fazer a manuten√ß√£o dos segmentos do banco
‚ñ∂Ô∏è N√£o √© uma atividade complexa, mas requer cuidados, principalmente em bancos grandes e de alto volume de acesso


=================================================================
== üéØ O que s√£o dados fragmentados?
=================================================================
‚ñ∂Ô∏è Fragmenta√ß√£o de segmentos ocorre quando h√° espa√ßo desperdi√ßado dentro de segmentos de dados, como tabelas e √≠ndices. 
‚ñ∂Ô∏è Isso pode degradar a performance do banco de dados, aumentando o tempo de resposta das consultas.


=================================================================
== üéØ Chained Rows
=================================================================
‚ñ∂Ô∏è Chained Rows (linhas encadeadas) acontecem quando uma linha √© maior que o tamanho do bloco de dados. 
‚ñ∂Ô∏è Faz com que a linha se espalhe por v√°rios blocos.


=================================================================
== üéØ Upgraded Rows
=================================================================
‚ñ∂Ô∏è Upgraded Rows (linhas atualizadas) ocorrem quando uma linha √© atualizada e n√£o cabe mais no espa√ßo originalmente alocado.
‚ñ∂Ô∏è Quando isso ocorre, move parte ou toda a linha para um novo bloco.


=================================================================
== üéØ Quais os principais motivos de fazermos a manuten√ß√£o de segmentos
=================================================================
‚ñ∂Ô∏è Desempenho
	‚ñ´Ô∏è Degrada√ß√£o de performance devido a fragmenta√ß√£o dos segmentos 
‚ñ∂Ô∏è Gerenciamento de espa√ßo
	‚ñ´Ô∏è Compacta√ß√£o dos segmentos


=================================================================
== üéØ Meios de realizar a manuten√ß√£o dos segmentos
=================================================================
‚ñ∂Ô∏è Podemos fazer a manuten√ß√£o atrav√©s de dois comandos:
    ‚ñ´Ô∏è MOVE
    ‚ñ´Ô∏è SHIRNK
‚ñ∂Ô∏è Com o comando MOVE, √© poss√≠vel realizar uma s√©rie de atividades
    ‚ñ´Ô∏è Mover segmentos para outras tablespaces
    ‚ñ´Ô∏è Compactar segmentos
    ‚ñ´Ô∏è Resolver problemas de fragmenta√ß√£o
    ‚ñ´Ô∏è Mudar o grau de paralelismo
‚ñ∂Ô∏è Com o comando SHRINK, √© poss√≠vel realizar apenas:
    ‚ñ´Ô∏è Resolver problemas de fragmenta√ß√£o


=================================================================
== üéØ Criando cen√°rio de fragmenta√ß√£o
=================================================================
-- Criando usuario de teste
SQL> drop user xpto cascade;
SQL> create tablespace ts_xpto;
SQL> create user xpto identified by xpto ;
SQL> alter user xpto default tablespace ts_xpto;
SQL> grant create session, create table to xpto;
SQL> alter user xpto quota unlimited on ts_xpto;
SQL> alter session set current_schema = xpto;

SQL> set timing on
-- criando objetos
SQL> create table t1 as (select * from dba_objects);
SQL> insert into t1 (select * from t1);
SQL> insert into t1 (select * from t1);
SQL> insert into t1 (select * from t1);
SQL> insert into t1 (select * from t1);
SQL> create table t2 as (select * from t1);
SQL> create table t3 as (select * from t1);
SQL> create table t4 as (select * from t1);

SQL> create index idx_t1 on t1 (object_name);
SQL> set timing off

-- Gerando "Buracos" 
SQL> delete from t2 where object_type = 'SYNONYM';
SQL> commit;

-- Diminuindo a ocupa√ß√£o dos blocos
SQL> UPDATE t3
SET
    owner = 'A',
    object_type = 'B',
    object_name = 'C'
WHERE
    object_type = 'SYNONYM';

SQL> commit;

SQL> alter table t4 modify owner varchar2(200);
SQL> alter table t4 modify object_type varchar2(200);
SQL> alter table t4 modify object_name varchar2(200);
SQL> UPDATE t4
SET
    owner = 'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA',
    object_type = 'BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB',
    object_name = 'CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC'
WHERE
    object_type = 'SYNONYM';

SQL> commit;

SQL> EXEC DBMS_STATS.GATHER_SCHEMA_STATS('XPTO', cascade => TRUE, degree => 4);
SQL> col table_name form a20
SQL> col num_rows form 999,999,999
SQL> select table_name, num_rows from dba_tables where owner = 'XPTO';

SQL> col blocks form 999,999,999
SQL> col segment_name form a20
SQL> select segment_name, bytes/1024/1024 size_mb, blocks from dba_segments where owner = 'XPTO';

SEGMENT_NAME            SIZE_MB       BLOCKS
-------------------- ---------- ------------
T2                          184       23,552
T1                          184       23,552
T3                          184       23,552
T4                          224       28,672
IDX_T1                       60        7,680


SEGMENT_NAME            SIZE_MB       BLOCKS
-------------------- ---------- ------------
T2                     154.3125       19,752
T1                      178.375       22,832
T3                          176       22,528
T4                       221.25       28,320
IDX_T1                  59.1875        7,576

=================================================================
== üéØ Detectando a fragmenta√ß√£o
=================================================================
SQL> @segment_advisor TABLE XPTO T1
SQL> @segment_advisor TABLE XPTO T2
SQL> @segment_advisor TABLE XPTO T3
SQL> @segment_advisor TABLE XPTO T4
SQL> @segment_advisor INDEX XPTO IDX_T1


=================================================================
== üéØ Resolvendo o problema de fragmenta√ß√£o
=================================================================
SQL> alter table "XPTO"."T1" enable row movement;
SQL> alter table "XPTO"."T2" enable row movement;
SQL> alter table "XPTO"."T3" enable row movement;
SQL> alter table "XPTO"."T4" enable row movement;

SQL> alter table "XPTO"."T1" shrink space;
SQL> alter table "XPTO"."T2" shrink space;
SQL> alter table "XPTO"."T3" shrink space;
SQL> alter table "XPTO"."T4" shrink space;
SQL> alter INDEX "XPTO"."IDX_T1" shrink space;


=================================================================
== üéØ Analisando a tablespace inteira
=================================================================
SQL> @segment_advisor TABLESPACE TS_SOE NULL


=================================================================
== üéØ Conclus√£o
=================================================================
‚ñ∂Ô∏è √â uma atividade t√≠pica do DBA
‚ñ∂Ô∏è √â preciso compreender quais as causas de um segmento ficar fragmentado
‚ñ∂Ô∏è Saiba identificar os segmentos fragmentados do banco
‚ö†Ô∏è Aten√ß√£o aos segmentos grandes, podem gerar alto consumo de recursos
‚ö†Ô∏è Fa√ßa essas atividades dentro de uma janela de manuten√ß√£o
‚ö†Ô∏è Se poss√≠vel, execute no ambiente de testes, para validar os scripts e ter uma estimativa de tempo