|-------------------------------------------------------------------------------|
| Aula      :Analisando a performance de queries				 				|
| MÃ³dulo    : IntroducÌ§aÌƒo a performance e tuning                                 |
| Curso     : Oracle Fundamentals                                               |
| Instrutor : Marcio Mandarino                                                  |
| URL       : mrdba.com.br/oracle_fundamentals                                  |
|-------------------------------------------------------------------------------|
| ReferÃªncia: https://docs.oracle.com/en/database/oracle/oracle-database/19/tgsql/sql-tuning-advisor.html#GUID-36E17A9F-7912-483D-A10F-7748BBB924E0
|-------------------------------------------------------------------------------|


=================================================================
== ğŸ¯ Objetivos da Aula:
=================================================================
ğŸ’¡ Ser capaz de gerar o plano de execuÃ§Ã£o de uma query
ğŸ’¡ Gerar recomendaÃ§Ãµes de performance para uma query lenta


=================================================================
== ğŸ¯ Resumo
=================================================================
ğŸ“ Conceito geral
ğŸ“ Por onde comeÃ§ar?
ğŸ“ Plano de execuÃ§Ã£o da query
ğŸ“ Plano de execuÃ§Ã£o da query que vocÃª estÃ¡ executando
ğŸ“ O custo de uma query
ğŸ“ Criando um cenÃ¡rio com query problemÃ¡tica
ğŸ“ Eecutando o SQL Tuning Advisor
ğŸ“ Scripts Ãºteis
ğŸ“ ConclusÃ£o

=================================================================
== ğŸ¯ Conceito geral
=================================================================
â–¶ï¸ Analisar a performance de queries pode ser complexo para DBA iniciantes
â–¶ï¸ Um DBA iniciante nÃ£o tem a obrigaÃ§Ã£o de saber analisar a performance de queries
	ğŸ’¡ Mas ele pode ter algumas "cartas na manga" para conseguir realizar uma anÃ¡lise incial


=================================================================
== ğŸ¯ Por onde comeÃ§ar?
=================================================================
â–¶ï¸ Saiba identificar as top queries do banco
	â–«ï¸ Baseado em que? CPU? I/O? Qual wait?
â–¶ï¸ Saiba gerar um plano de execuÃ§Ã£o
â–¶ï¸ Identifique o custo da query
â–¶ï¸ Executar o SQL Performance Analyzer e pegar a recomendaÃ§Ã£o 



=================================================================
== ğŸ¯ Plano de execuÃ§Ã£o da query
=================================================================
â–¶ï¸ O plano de execuÃ§Ã£o Ã© o caminho que o banco de dados vai percorrer para buscar a informaÃ§Ã£o 
â–¶ï¸ VocÃª pode gerar o plano de execuÃ§Ã£o para uma query que vocÃª vai executar
â–¶ï¸ O mais comum Ã© gerar o plano de execuÃ§Ã£o para uma query que foi executada pelo sistema


=================================================================
== ğŸ¯ Plano de execuÃ§Ã£o da query que vocÃª estÃ¡ executando
=================================================================
â–¶ï¸ MÃ©todo 1: Explain plan <<SELECT>>
â–¶ï¸ MÃ©todo 2: set autotrace traceonly

Ex1.
SQL> create table t1 (x date);
SQL> insert into t1 values (sysdate);
SQL> commit; 
SQL> explain plan for select * from t1;
SQL> col PLAN_TABLE_OUTPUT form a120
SQL> SELECT PLAN_TABLE_OUTPUT  FROM TABLE(DBMS_XPLAN.DISPLAY(null, NULL,'TYPICAL'));

Ex2. 
SQL> SET AUTOTRACE TRACEONLY
SQL> select * from t1;
SQL> SET AUTOTRACE OFF


SQL> col PLAN_TABLE_OUTPUT head SQL_TEXT format a850 word_wrap
SQL> select * from TABLE(dbms_xplan.display_awr('5ckxyqfvu60pj'));


Ex3.
SQL> @sql_id 22356bkgsdcnh



=================================================================
== ğŸ¯ O custo de uma query
=================================================================
â–¶ï¸ O custo de uma query Ã© um nÃºmero que representa a quantidade de recursos computacionais necessÃ¡rios para executar a consulta.
â–¶ï¸ Esses recursos podem incluir CPU, memÃ³ria e operaÃ§Ãµes de I/O
â–¶ï¸ Muitos fatores influenciam o custo de uma query, por exemplo:
	â–«ï¸ Ãndices: Uso de Ã­ndices pode reduzir significativamente o custo
	â–«ï¸ EstatÃ­sticas Atualizadas: EstatÃ­sticas desatualizadas podem levar a estimativas de custo imprecisas.
	â–«ï¸ NÃºmero de linhas da tabela



=================================================================
== ğŸ¯ Criando um cenÃ¡rio com query problemÃ¡tica
=================================================================
$ . oraenv
ORACLE_SID = [orcl] ? orcl

$ sqlplus / as sysdba

-- Criando um usuÃ¡rio para testes
SQL> create user teste_spa;
SQL> grant create session, create table to teste_spa;
SQL> alter user teste_spa quota unlimited on users;

SQL> drop TABLE employees;


-- Criando uma tabela
CREATE TABLE teste_spa.employees (
    employee_id NUMBER ,
    first_name VARCHAR2(50),
    last_name VARCHAR2(50),
    email VARCHAR2(100),
    hire_date DATE
);


-- Fazendo uma carga na tabela
BEGIN
    FOR i IN 1..1000000 LOOP
        INSERT INTO teste_spa.employees (employee_id, first_name, last_name, email, hire_date) 
        VALUES (
            i,
            'FirstName' || i,
            'LastName' || i,
            'email' || i || '@example.com',
            TO_DATE('2020-01-01', 'YYYY-MM-DD') + MOD(i, 365)
        );
    END LOOP;
    COMMIT;
END;
/


-- Atualizando as estatÃ­sticas da tabela
SQL> EXEC dbms_stats.gather_table_stats(ownname => 'TESTE_SPA', tabname =>'EMPLOYEES', cascade => TRUE);

-- Executando uma query
SQL> select first_name from teste_spa.EMPLOYEES where employee_id = 100;

-- Gerando o plano de execuÃ§Ã£o
SQL> set lines 200
SQL> alter system flush shared_pool;
SQL> alter system flush buffer_cache;
SQL> set autotrace traceonly
SQL> select first_name from teste_spa.EMPLOYEES where employee_id = 100;

SQL> set autotrace off
SQL> select sql_id from v$sql where sql_text = 'select first_name from teste_spa.EMPLOYEES where employee_id = 100';




=================================================================
== ğŸ¯ Eecutando o SQL Tuning Advisor
=================================================================
-- Criando a task
SQL> set serverout on
SQL> DECLARE
  l_sql_tune_task_id  VARCHAR2(100);
BEGIN
  l_sql_tune_task_id := DBMS_SQLTUNE.create_tuning_task (
                          sql_id      => 'awgp66vtuyfn5',
                          scope       => DBMS_SQLTUNE.scope_comprehensive,
                          time_limit  => 800,
                          task_name   => 'Advice_awgp66vtuyfn5',
                          description => 'Tuning task1 for statement awgp66vtuyfn5');
  DBMS_OUTPUT.put_line('l_sql_tune_task_id: ' || l_sql_tune_task_id);
END;
/

-- Executando a task
SQL> exec dbms_sqltune.execute_tuning_task(task_name => 'Advice_awgp66vtuyfn5');

-- Gerando o report
SQL> SET LONG 1000000
SQL> SET LONGCHUNKSIZE 1000000
SQL> SET LINESIZE 1000
SQL> col recomandation form a120
SQL> select dbms_sqltune.report_tuning_task('Advice_awgp66vtuyfn5') recomandation from dual;


-- Aplicar recomendaÃ§Ã£o


create index TESTE_SPA.idx_EMPLOYEE_ID on
    TESTE_SPA.EMPLOYEES("EMPLOYEE_ID");

-- Verificando o resultado
SQL> alter system flush shared_pool;
SQL> alter system flush buffer_cache;
SQL> set autotrace traceonly
SQL> select first_name from teste_spa.EMPLOYEES where employee_id = 100;

Statistics
----------------------------------------------------------
    107  recursive calls
      0  db block gets
      10232  consistent gets
      10114  physical reads
      0  redo size
    562  bytes sent via SQL*Net to client
    428  bytes received via SQL*Net from client
      2  SQL*Net roundtrips to/from client
      9  sorts (memory)
      0  sorts (disk)
      1  rows processed


=================================================================
== ğŸ¯ Scripts Ãºteis
=================================================================
@adv_sql



=================================================================
== ğŸ¯ ConclusÃ£o
=================================================================
ğŸ’¡ O SQL Performance Analyzer Ã© muito bom, mas nÃ£o acerta 100%
ğŸ’¡ Sempre pegue as recomendaÃ§Ãµes
âš ï¸ Nem sempre aplique as recomendaÃ§Ãµes
ğŸ’¡ Procure sempre implementar as sugestÃµes em ambientes de teste/dev primeiro
ğŸ’¡ Ã‰ uma mÃ£o na roda para o iniciante, pois fornece meios de gerar uma recomendaÃ§Ã£o de performance, mesmo sem entender muito de SQL Tuning
ğŸ’¡ O que foi mostrado aqui, Ã© apenas o comeÃ§o. Busque evoluir em SQL Tuning, Ã© um grande diferencial na carreira do DBA
ğŸ’¡ Divulgue os resultados obtidos!
ğŸ’¡ FaÃ§a as simulaÃ§Ãµes dessa aula 