|-------------------------------------------------------------------------------|
| Aula      : Average Active Session 											|
| MÃ³dulo    : IntroducÌ§aÌƒo a performance e tuning                                 |
| Curso     : Oracle Fundamentals                                               |
| Instrutor : Marcio Mandarino                                                  |
| URL       : mrdba.com.br/oracle_fundamentals                                  |
|-------------------------------------------------------------------------------|
| ReferÃªncia: 
|-------------------------------------------------------------------------------|


=================================================================
== ğŸ¯ Objetivos da Aula:
=================================================================
ğŸ’¡ Aprender o que significa a mÃ©trica Average Active Session 
ğŸ’¡ Fazer troubleshooting no banco para identificar problemas de performance


=================================================================
== ğŸ¯ Resumo
=================================================================
ğŸ“ Conceito geral
ğŸ“ Como Calcular o AAS
ğŸ“ Como Calcular o AAS
ğŸ“ Como saber se o meu AAS Ã© bom ou ruim?
ğŸ“ O que o AAS nos demonstra? 
ğŸ“ CenÃ¡rio
ğŸ“ Analisando performance
ğŸ“ Scripts utilziados
ğŸ“ ConclusÃ£o

=================================================================
== ğŸ¯ Conceito geral
=================================================================
â–¶ï¸ Average Active Session (AAS) Ã© uma mÃ©trica muito Ãºtil quando queremos avaliar a performance do banco de uma forma mais ampla
â–¶ï¸ Essa mÃ©trica ao mesmo tempo que ela Ã© extremamente Ãºtil, o conceito dela Ã© confundido de uma forma gigantesca
â–¶ï¸ Quando fazemos uma traduÃ§Ã£o literal "MÃ©dia de SessÃµes Ativas", nÃ£o Ã© possÃ­vel compreender a dimensÃ£o dessa mÃ©trica
â–¶ï¸ Essa mÃ©trica representa o nÃºmero de sessÃµes que estÃ¡ executando algo ou aguardando algum recurso em algum ponto do tempo.
	â–«ï¸ SessÃµes em Idle (inativas) nÃ£o influenciam no AAS
â–¶ï¸ De uma forma geral, AAS representa a mÃ©dia da quantidade de tempo que o database levou para processar queries a cada segundo


=================================================================
== ğŸ¯ Como Calcular o AAS
=================================================================
â–¶ï¸ O AAS Ã© calculado com base em dois indicadores: DB Time e Elapsed Time
â–¶ï¸ JÃ¡ vimos que o DB Time Ã© o tempo que o database leva para atender as requisÃµes do usuÃ¡rio
â–¶ï¸ JÃ¡ o Elapsed Time Ã© o tempo como conhecemos, em um segundos, minutos e horas...
â–¶ï¸ Para calcular o AAS precisamos dividir o DB Time pelo Elapsed Time



=================================================================
== ğŸ¯ Como Calcular o AAS
=================================================================
		  10:01	  10:02	  10:03	  10:04	  10:05	  10:06	  10:07	  10:08	  10:09	  10:10
			|		|		|		|		|		|		|		|		|		|
----------------------------------------------------------------------------------------
User 1		ğŸ”¥		ğŸ”¥		ğŸ”¥		ğŸ”¥		ğŸ”¥		ğŸ”¥		ğŸ”¥		ğŸ”¥		ğŸ”¥		ğŸ”¥
User 2		ğŸ”¥		ğŸ”¥		â³		â³		â³		â³		â³		â³		â³		â³
User 3		ğŸ˜´		ğŸ˜´		ğŸ˜´		ğŸ”¥		ğŸ”¥		ğŸ”¥		ğŸ”¥		ğŸ”¥		ğŸ”¥		ğŸ”¥
User 4		â³		â³		â³		â³		ğŸ”¥		ğŸ”¥		ğŸ”¥		ğŸ”¥		ğŸ”¥		ğŸ”¥
User 5		ğŸ”¥		ğŸ”¥		ğŸ”¥		ğŸ”¥		â³		â³		ğŸ”¥		ğŸ˜´		ğŸ˜´		ğŸ˜´



Legenda
-----------------------------
ğŸ”¥ Processamento em CPU
â³ Aguardando algum recurso (I/O, rede, bloqueios, etc..)
ğŸ˜´ UsuÃ¡rio Idle (inativo)

â–¶ï¸ O Elapsed Time foi de 10 segundos
â–¶ï¸ O DB Time foi de 44 segundos
â–¶ï¸ AAS = DB Time / Elapsed Time
â–¶ï¸ AAS = 44 / 10 = 4,4
ğŸ’¡ VocÃª nÃ£o vai precisar ficar fazendo cÃ¡lculos, basta consultar as views do Oracle!

=================================================================
== ğŸ¯ Como saber se o meu AAS Ã© bom ou ruim?
=================================================================
â–¶ï¸ Comparando pela quantidade de CPUs disponÃ­veis para o banco de dados, simples assim.
â–¶ï¸ Se o AAS for maior que a quantidade de CPUs disponÃ­veis para o banco, vocÃª tem um problema
	â–«ï¸ Qual o tamanho do problema? Vai depender de quÃ£o maior for o AAS...

datadog
https://datadog-docs.imgix.net/images/database_monitoring/dbm_apm_active_connections_breakdown.8dc3c9b02346f88c0fcf75c6bc142c4f.png?fit=max&auto=format&w=1920&h=879&dpr=2

Oracle Enterprise Manager Cloud Control
https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh00O7xG7ulHOCWS0ZrO3OXn_LGgFlXPvzoiyXv1dafyzAPKC5tUrecfwlb68E4NrBRLAjP9SwB7jBc6imue6hSCQNqyZyUfnlAU_45XNR05XSjp_hOCoLs69PFRNYYHuoQK_2cQFxp8IA/s1600/2020-02-19+08_18_38-Top+Activity_+MRPPRD01+%2528Database+Instance%2529+-+Oracle+Enterprise+Manager.jpg


=================================================================
== ğŸ¯ O que o AAS nos demonstra? 
=================================================================
â–¶ï¸ O load do Database
â–¶ï¸ Revela a Performance do banco de dados
â–¶ï¸ Detecta gargÃ¡los de performance
â–¶ï¸ Ã‰ uma mÃ©trica poderosa de anÃ¡lise de desempenho


=================================================================
== ğŸ¯ CenÃ¡rio
=================================================================
-- SessÃ£o1 :
SQL> create table X (i number); 
SQL> insert into X values (1);
SQL> commit; 
SQL> select * from X where i = 1 for update;

-- SessÃ£o 2:
$ top

-- SessÃ£o 3
SQL> update X set i = 2 where i =1;


-- SessÃ£o 4 (Sql Developer)
SELECT
    begin_time,
    round(value, 2) aas
FROM
    gv$sysmetric_history
WHERE
        metric_name = 'Average Active Sessions'
    AND group_id = 2
ORDER BY
    begin_time DESC;

@ash 4

    
=================================================================
== ğŸ¯ Analisando performance
=================================================================
â–¶ï¸ O AAS vai nos dizer se o banco estÃ¡ com problemas ou nÃ£o (@aas)
â–¶ï¸ A V$ACTIVE_SESSION_HISTORY vai nos ajudar a identificar qual problema (@ash, @ash2 e @ash3)
â–¶ï¸ O @sql_id nos ajuda a identificar o sql ofensor


=================================================================
== ğŸ¯ Scripts utilziados
=================================================================
ğŸ’¡ @ash
ğŸ’¡ @ash2
ğŸ’¡ @ash3
ğŸ’¡ @aas (novo)
ğŸ’¡ @sql_id


=================================================================
== ğŸ¯ ConclusÃ£o
=================================================================
ğŸ’¡ Com esse conhecimento, vocÃª consegue analisar o presente e o passado recente
ğŸ’¡ FaÃ§a, refaÃ§a a exaustÃ£o essas atividades
ğŸ’¡ Domine os scripts dessa aula
ğŸ’¡ Salve todos os scripts na sua pasta de scripts
ğŸ’¡ Pratique atÃ© ter desenvoltura na anÃ¡lise
ğŸ’¡ NÃ£o Ã© a Ãºnica forma de se identificar problemas, mas Ã© uma forma muito eficiente
ğŸ’¡ a View GV$SYSMETRIC_HISTORY tem vÃ¡rias outras mÃ©tricas, estude aos poucos novas mÃ©tricas!

 