|-------------------------------------------------------------------------------|
| Aula      : Move de segemntos 												|
| M√≥dulo    : IntroducÃßaÃÉo a performance e tuning                                 |
| Curso     : Oracle Fundamentals                                               |
| Instrutor : Marcio Mandarino                                                  |
| URL       : mrdba.com.br/oracle_fundamentals                                  |
|-------------------------------------------------------------------------------|
| Refer√™ncia: https://docs.oracle.com/en/database/oracle/oracle-database/19/admin/managing-tables.html#GUID-D4AE1CF2-08F7-4AB2-9317-0DE20AC70D44
|-------------------------------------------------------------------------------|


=================================================================
== üéØ Objetivos da Aula:
=================================================================
üí° Aprender a realizar o move dos segmentos com seguran√ßa


=================================================================
== üéØ Resumo
=================================================================
üìç Conceito geral
üìç Quais os principais motivos de fazermos a manuten√ß√£o de segmentos
üìç Criando o Ambiente de Teste
üìç Explica√ß√£o dos Par√¢metros do MOVE TABLE
üìç Verifica√ß√£o do tamamnho da tabela
üìç Verificando o plano da query
üìç Execu√ß√£o do MOVE TABLE
üìç Testando √çndice Ap√≥s MOVE
üìç Rebuild do √çndice
üìç Execu√ß√£o do MOVE TABLE com UPDATE INDEXES
üìç Execu√ß√£o do MOVE TABLE com PARALLEL
üìç Execu√ß√£o do MOVE TABLE online
üìç Execu√ß√£o do MOVE TABLE com compress
üìç Tudo em um
üìç Cuidados ao Realizar o MOVE TABLE
üìç Conclus√£o

=================================================================
== üéØ Conceito geral
=================================================================
‚ñ∂Ô∏è √â uma atividade t√≠pica do DBA mover segmentos no banco de dados
‚ñ∂Ô∏è N√£o √© uma atividade complexa, mas requer cuidados, principalmente em bancos grandes e de alto volume de acesso


=================================================================
== üéØ Quais os principais motivos de fazermos a manuten√ß√£o de segmentos
=================================================================
‚ñ∂Ô∏è Organiza√ß√£o
	‚ñ´Ô∏è Organizar segmentos em tablespaces espec√≠ficas
‚ñ∂Ô∏è Desempenho
	‚ñ´Ô∏è Degrada√ß√£o de performance devido a fragmenta√ß√£o dos segmentos 
‚ñ∂Ô∏è Gerenciamento de espa√ßo
	‚ñ´Ô∏è Compacta√ß√£o dos segmentos


=================================================================
== üéØ Criando o Ambiente de Teste
=================================================================
SQL> CREATE TABLESPACE new_tablespace;
SQL> create user teste_move identified by teste_move default tablespace new_tablespace;
SQL> alter user teste_move quota unlimited on users;
SQL> alter user teste_move quota unlimited on new_tablespace;
SQL> grant create session, resource to teste_move;
SQL> conn teste_move/teste_move

SQL> CREATE TABLE emp_test (
    employee_id NUMBER(6),
    first_name VARCHAR2(20),
    last_name VARCHAR2(25) CONSTRAINT emp_last_name_nn NOT NULL,
    email VARCHAR2(25) CONSTRAINT emp_email_nn NOT NULL,
    phone_number VARCHAR2(20),
    hire_date DATE CONSTRAINT emp_hire_date_nn NOT NULL,
    job_id VARCHAR2(10) CONSTRAINT emp_job_nn NOT NULL,
    salary NUMBER(8,2),
    commission_pct NUMBER(2,2),
    manager_id NUMBER(6),
    department_id NUMBER(4)
);

SQL> BEGIN
    FOR i IN 1..900000 LOOP
        INSERT INTO emp_test (employee_id, first_name, last_name, email, phone_number, hire_date, job_id, salary, commission_pct, manager_id, department_id)
        VALUES (i, 'Name'||i, 'Surname'||i, 'email'||i||'@example.com', '1234567890', SYSDATE, 'IT_PROG', 5000 + dbms_random.value(0, 2000), dbms_random.value(0, 0.1), 100, 10);
    END LOOP;
    COMMIT;
END;
/

SQL> CREATE INDEX emp_test_idx01 ON emp_test(last_name);
SQL> CREATE INDEX emp_test_idx02 ON emp_test(first_name);
SQL> CREATE INDEX emp_test_idx03 ON emp_test(employee_id);
SQL> CREATE INDEX emp_test_idx04 ON emp_test(email);


=================================================================
== üéØ Explica√ß√£o dos Par√¢metros do MOVE TABLE & REBUILD
=================================================================
‚úÖ TABLESPACE		: Especifica uma tablespace para o qual a tabela ser√° movida.
‚úÖ ONLINE			: Permite que a tabela continue online durante a opera√ß√£o (EE)
‚úÖ PARALLEL 			: Utiliza processamento paralelo para acelerar a opera√ß√£o (EE)
‚úÖ UPDATE INDEXES	: Atualiza os √≠ndices automaticamente ap√≥s o move da tabela
‚úÖ NOLOGGING/LOGGING	: Gera o m√≠nimo de redo (üß®)
‚úÖ COMPRESS          : Aplica compress√£o (EE)


=================================================================
== üéØ Verifica√ß√£o do tamamnho da tabela
=================================================================
SQL> set lines 200
SQL> set timing on
SQL> col segment_name form a20
SQL> col tablespace_name form a20
SQL> SELECT segment_name, bytes/1024/1024 AS size_MB, tablespace_name 
FROM user_segments 
WHERE segment_name = 'EMP_TEST';


=================================================================
== üéØ Verificando o plano da query
=================================================================
SQL> SET AUTOTRACE ON
SQL> SELECT * FROM emp_test WHERE last_name = 'Surname5000';
SQL> SET AUTOTRACE OFF


=================================================================
== üéØ Execu√ß√£o do MOVE TABLE
=================================================================
SQL> ALTER TABLE emp_test MOVE;


=================================================================
== üéØ Testando √çndice Ap√≥s MOVE
=================================================================
SQL> col index_name format a20
SQL> col status format a10
SQL> SELECT index_name, status FROM dba_indexes WHERE table_name = 'EMP_TEST';
-- O √≠ndice emp_test_idx dever√° aparecer como 'UNUSABLE'

-- Tentando usar o √≠ndice emp_test_idx
SQL> SET AUTOTRACE ON
SQL> SELECT * FROM emp_test WHERE last_name = 'Surname5000';
SQL> SET AUTOTRACE OFF


=================================================================
== üéØ Rebuild do √çndice
=================================================================
SQL> ALTER INDEX emp_test_idx01 REBUILD ONLINE;
SQL> ALTER INDEX emp_test_idx02 REBUILD ONLINE;
SQL> ALTER INDEX emp_test_idx03 REBUILD ONLINE;
SQL> ALTER INDEX emp_test_idx04 REBUILD ONLINE;

=================================================================
== üéØ Execu√ß√£o do MOVE TABLE com UPDATE INDEXES
=================================================================
SQL> ALTER TABLE emp_test MOVE;
SQL> ALTER TABLE emp_test MOVE TABLESPACE new_tablespace UPDATE INDEXES ONLINE ;

-- Verificando o estado do √≠ndice ap√≥s o MOVE com UPDATE INDEXES
SQL> SELECT index_name, status FROM user_indexes WHERE table_name = 'EMP_TEST';




=================================================================
== üéØ Execu√ß√£o do MOVE TABLE com PARALLEL
=================================================================
SQL> ALTER TABLE emp_test MOVE UPDATE INDEXES ONLINE PARALLEL 8;


=================================================================
== üéØ Execu√ß√£o do MOVE TABLE online
=================================================================
SQL> ALTER TABLE emp_test MOVE TABLESPACE users  ONLINE ;


=================================================================
== üéØ Execu√ß√£o do MOVE TABLE com compress
=================================================================
SQL> SELECT segment_name, bytes/1024/1024 AS size_MB, tablespace_name 
FROM dba_segments 
WHERE owner = 'TESTE_MOVE';


SQL> ALTER TABLE emp_test MOVE TABLESPACE new_tablespace COMPRESS  ;


=================================================================
== üéØ Tudo em um
=================================================================
SQL> ALTER TABLE emp_test MOVE TABLESPACE new_tablespace COMPRESS FOR OLTP ONLINE PARALLEL 4 UPDATE INDEXES;


SQL> ALTER TABLE emp_test MOVE TABLESPACE teste NOCOMPRESS  ;



=================================================================
== üéØ Cuidados ao Realizar o MOVE TABLE
=================================================================
‚ö†Ô∏è Aten√ß√£o para a gera√ß√£o de archives no servidor (espa√ßo em disco, FRA)
‚ö†Ô∏è Cuidado redobrado ao fazer move de tabelas grandes
‚ö†Ô∏è Avalie o espa√ßo livre nas tablespaces antes de realizar a manuten√ß√£o
‚ö†Ô∏è Fa√ßa dentro de uma janela de manuten√ß√£o
‚ö†Ô∏è Apesar de ser online (quando no EE), tem alto impacto na performance
‚ö†Ô∏è Se poss√≠vel, valide em um ambiente de testes
‚ö†Ô∏è Monitore a opera√ß√£o
 

=================================================================
== üéØ Conclus√£o
=================================================================
‚ñ∂Ô∏è Mover segmentos, principalmente por quest√µes de fragmenta√ß√£o ou de organiza√ß√£o s√£o quest√µes t√≠picas de um DBA
‚ñ∂Ô∏è Fa√ßa sempre com seguran√ßa
‚ñ∂Ô∏è √â f√°cil, mas requer cautela