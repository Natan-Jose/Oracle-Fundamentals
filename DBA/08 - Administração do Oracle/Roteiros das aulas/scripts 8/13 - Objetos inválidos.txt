|-------------------------------------------------------------------------------|
| Aula      : Objetos invÃ¡lidos													|
| MÃ³dulo    : Managing Oracle Database                                          |
| Curso     : Oracle Fundamentals                                               |
| Instrutor : Marcio Mandarino                                                  |
| URL       : mrdba.com.br/oracle_fundamentals                                  |
|-------------------------------------------------------------------------------|
| ReferÃªncia: 
|-------------------------------------------------------------------------------|


=================================================================
== ğŸ¯ Objetivos da Aula:
=================================================================
ğŸ’¡ Compreender o conceito de objetos invÃ¡lidos no Oracle Database
ğŸ’¡ Utilizar o comando ALTER COMPILE para recompilar objetos
ğŸ’¡ Utilizar o pacote DBMS_UTILITY.compile_schema para recompilar objetos em um esquema
ğŸ’¡ Explorar a view DBA_OBJECTS para monitorar o status dos objetos
ğŸ’¡ Entender os motivos pelos quais um objeto pode ficar invÃ¡lido
ğŸ’¡ Simular um cenÃ¡rio onde uma procedure fica invÃ¡lida apÃ³s uma alteraÃ§Ã£o em uma tabela


=================================================================
== ğŸ¯ Resumo
=================================================================
ğŸ“ Conceito geral
ğŸ“ Compilando um objeto invÃ¡lido
ğŸ“ Pacote DBMS_UTILITY.compile_schema
ğŸ“ Verificando objetos invÃ¡lidos
ğŸ“ DependÃªncia de objetos
ğŸ“ Exemplo prÃ¡tico de objetos invÃ¡lidos
ğŸ“ @inv
ğŸ“ @inv2
ğŸ“ @compile_schema
ğŸ“ ConclusÃ£o

=================================================================
== ğŸ¯ Conceito geral
=================================================================
â–¶ï¸ Os objetos invÃ¡lidos ficam com o status de INVALID na DBA_OBJECTS (coluna STATUS)
â–¶ï¸ Os objetos nÃ£o podem ser utilizados atÃ© que seu status esteja vÃ¡lido	
â–¶ï¸ Ã‰ uma tarefa cotidiana do DBA cuidar do status dos objetos do banco
ğŸ’¡ Ã‰ uma boa prÃ¡tica manter o banco de dados sem objetos invÃ¡lidos
â–¶ï¸ AlteraÃ§Ãµes em objetos que tenham dependÃªncia, deixam os objetos dependentes invÃ¡lidos
	â–«ï¸ Neste caso, basta compilar o objeto que ele volta a ficar invÃ¡lido
â–¶ï¸ Um objeto pode ficar invÃ¡lido por diversos motivos:
	â–«ï¸ CÃ³digo errado
	â–«ï¸ Falta de privilÃ©gios
	â–«ï¸ CriaÃ§Ã£o do objeto no lugar errado
	â–«ï¸ Objeto dependente alterado


=================================================================
== ğŸ¯ Compilando um objeto invÃ¡lido
=================================================================
â–¶ï¸ O comando ALTER COMPILE Ã© utilizado para recompilar um objeto invÃ¡lido.

-- Recompilar uma procedure
SQL> ALTER PROCEDURE TESTE.Get_emp_names COMPILE;

-- Recompilar uma function
SQL> ALTER FUNCTION  TESTE.calcularSalarioAnual COMPILE;

-- Recompilar uma view
SQL> ALTER VIEW TESTE.VW_EMP_DEPT COMPILE;

-- Recompilar um trigger
SQL> ALTER TRIGGER TESTE.log_salary_increase COMPILE;

-- Recompilar um package 
SQL> ALTER package TESTE.simple_package COMPILE;

-- Recompilar um package body
SQL> ALTER package TESTE.simple_package COMPILE BODY;

SQL> COL object_name form a20
SQL> col status form a10
SQL> select object_name,OBJECT_TYPE, status from dba_objects where owner = 'TESTE';

=================================================================
== ğŸ¯ Pacote DBMS_UTILITY.compile_schema
=================================================================
â–¶ï¸ O pacote DBMS_UTILITY.compile_schema recompila todos os objetos invÃ¡lidos em um esquema especÃ­fico.

-- Recompilar todos os objetos invÃ¡lidos no esquema TESTE
SQL> EXEC DBMS_UTILITY.compile_schema(schema => 'TESTE');


=================================================================
== ğŸ¯ Verificando objetos invÃ¡lidos
=================================================================
-- Consultar objetos invÃ¡lidos no banco de dados

SQL> set lines 200
SQL> col owner form a20
SQL> col object_name form a20
SQL> col object_type form a20
SQL> col status form a20
SQL> SELECT owner, object_name, object_type, status
FROM dba_objects
WHERE status = 'INVALID';


=================================================================
== ğŸ¯ DependÃªncia de objetos
=================================================================
â–¶ï¸ Para gerenciar dependÃªncias entre objetos, o Oracle Database fornece vÃ¡rias views que ajudam a identificar quais objetos dependem de outros.
	â–«ï¸ DBA_DEPENDENCIES
	â–«ï¸ ALL_DEPENDENCIES
	â–«ï¸ USER_DEPENDENCIES


-- Consultar objetos que dependem de uma tabela especÃ­fica

SQL> col owner form a20
SQL> col name form a20
SQL> SELECT owner, name, type
FROM dba_dependencies
WHERE referenced_owner = 'TESTE' AND referenced_name = 'EMP';

=================================================================
== ğŸ¯ Exemplo prÃ¡tico de objetos invÃ¡lidos
=================================================================
-- Criar uma tabela de exemplo
SQL> CREATE TABLE teste.employees2 (
    employee_id NUMBER PRIMARY KEY,
    first_name VARCHAR2(50),
    last_name VARCHAR2(50)
);

-- Criar uma procedure que utiliza a tabela employees
SQL> CREATE OR REPLACE PROCEDURE teste.show_employees IS
BEGIN
    FOR emp IN (SELECT employee_id, first_name, last_name FROM employees2) LOOP
        DBMS_OUTPUT.PUT_LINE('Employee: ' || emp.first_name || ' ' || emp.last_name);
    END LOOP;
END;
/


SQL> SELECT owner, object_name, object_type, status
FROM dba_objects
WHERE owner = 'TESTE';



-- Excluir a tabela employees
SQL> drop table teste.employees2;

-- Verificar o status da procedure apÃ³s a alteraÃ§Ã£o na tabela
SQL> SELECT owner, object_name, status
FROM dba_objects
WHERE object_name = 'SHOW_EMPLOYEES';

SQL> ALTER PROCEDURE teste.SHOW_EMPLOYEES compile;
SQL> SHOW ERROR;

-- Recompilar todos os objetos invÃ¡lidos no esquema atual
SQL> EXEC DBMS_UTILITY.compile_schema(schema => 'TESTE');

=================================================================
== ğŸ¯ @inv
=================================================================
ğŸ’¡ Exibe os objetos invÃ¡lidos do banco de dados 

SQL> @inv

=================================================================
== ğŸ¯ @inv2
=================================================================
ğŸ’¡ Exibe os objetos invÃ¡lidos de um determinado schema

SQL> @inv TESTE

=================================================================
== ğŸ¯ @compile_schema
=================================================================
ğŸ’¡ Compila os objetos invÃ¡lidos de um schema

SQL> @compile_schema TESTE

=================================================================
== ğŸ¯ ConclusÃ£o
=================================================================
ğŸ’¡ Essa Ã© uma atividade cotidiana do DBA, domine-a.
ğŸ’¡ Sempre que criar ou alterar objetos em um banco, verifique se ficaram obejtos invÃ¡lidos
ğŸ’¡ Salve os scripts utilizados nessa aula na sua pasta de scripts
ğŸ’¡ Domine os scripts utilizados nessa aula!

