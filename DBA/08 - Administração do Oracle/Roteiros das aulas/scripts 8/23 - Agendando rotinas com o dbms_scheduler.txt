|-------------------------------------------------------------------------------|
| Aula      : Agendando rotinas com o dbms_scheduler                            |
| MÃ³dulo    : Managing Oracle Database                                          |
| Curso     : Oracle Fundamentals                                               |
| Instrutor : Marcio Mandarino                                                  |
| URL       : mrdba.com.br/oracle_fundamentals                                  |
|-------------------------------------------------------------------------------|
| ReferÃªncia: https://docs.oracle.com/en/database/oracle/oracle-database/19/arpls/DBMS_SCHEDULER.html
|-------------------------------------------------------------------------------|


=================================================================
== ğŸ¯ Objetivos da Aula:
=================================================================
ğŸ’¡ Aprender a usar o scheduler do Oracle

=================================================================
== ğŸ¯ Resumo
=================================================================
ğŸ“ Conceito geral
ğŸ“ Verificando o parÃ¢mtro job_queue_processes
ğŸ“ Criando um JOB
ğŸ“ InformaÃ§Ãµes sobre os jobs
ğŸ“ Executando o JOB
ğŸ“ Excluindo um JOB
ğŸ“ Criando um JOB com auto drop
ğŸ“ Modificando um JOB
ğŸ“ Parando um JOB em execuÃ§Ã£o
ğŸ“ Scripts Ãºteis
ğŸ“ ConclusÃ£o

=================================================================
== ğŸ¯ Conceito geral
=================================================================
â–¶ï¸ O pacote dmbs_scheduler foi introduzido no Oracle 10g
â–¶ï¸ Muito Ãºtil para agendar execuÃ§Ã£o de rotinas com uma frequÃªncia regular
â–¶ï¸ VocÃª pode executar comandos SQL, procedures, packages, shell script, backup, etc.
â–¶ï¸ Ele veio para substituir o pacote dbms_job, que foi deprecado na versÃ£o 12c
â–¶ï¸ A partir da versÃ£o 19c, os jobs gerenciados pelo dbms_job sÃ£o convertidos automaticamente para o dmbs_scheduler 
â–¶ï¸ O parÃ¢metro job_queue_processes deve estar com valor maior que zero (padrÃ£o 40)
â–¶ï¸ Views Ãºteis:
	â–«ï¸ DBA_SCHEDULER_JOBS -- Jobs do banco
	â–«ï¸ DBA_SCHEDULER_RUNNING_JOBS -- Jobs em execuÃ§Ã£o
	â–«ï¸ DBA_SCHEDULER_JOB_RUN_DETAILS -- HistÃ³rico dos jobs
	â–«ï¸ DBA_SCHEDULER_JOB_LOG -- Log dos jobs executados


======================================================================
== ğŸ¯ Verificando o parÃ¢mtro job_queue_processes
======================================================================
SQL> set lines 800
SQL> col value form a20
SQL> col name form a20
SQL> select name, value, ISDEFAULT,ISSYS_MODIFIABLE from v$Parameter where name = 'job_queue_processes';
SQL> alter system set job_queue_processes = 40 scope=spfile;

exec dbms_stats.gather_schema_stats (ownname => 'SOE' , cascade => TRUE, degree=>2);

======================================================================
== ğŸ¯ Criando um JOB
======================================================================

BEGIN
-- CREATE JOB
    dbms_scheduler.create_job
    (job_name       => 'SOE.UPDATE_STATS', 
    job_type        => 'PLSQL_BLOCK', -- STORED_PROCEDURE or PLSQL_BLOCK
    job_action      => 'dbms_stats.gather_schema_stats (ownname => ''SOE'' , cascade => TRUE, degree=>2);', 
    start_date      => sysdate, 
    repeat_interval => 'FREQ=DAILY;BYHOUR=1;BYMINUTE=30',
    enabled         => true, 
    comments        => 'ATUALIZA AS ESTATISTICAS DO OWNER SOE DIARIAMENTE');
END;
/

-- REPEAT_INTERVAL OPTIONS 
'FREQ=MINUTELY;INTERVAL=30' -- a cada trinta minutos
'FREQ=DAILY;INTERVAL=2' -- a cada dois dias
'FREQ=HOURLY;INTERVAL=1' -- a cada hora
'FREQ=DAILY;BYHOUR=01' -- todos os dias 01 da manhÃ£ (01 a 24)
'FREQ=DAILY;BYHOUR=1;BYMINUTE=30' -- todos os dias 01:30 da manhÃ£ (01 a 24)
'FREQ=WEEKLY; BYDAY=SAT; BYHOUR=9; BYMINUTE=0; BYSECOND=0;'

/* Dias da semana
SUN
SEC
TUE
WED
THU
FRI
SAT
*/




======================================================================
== ğŸ¯ InformaÃ§Ãµes sobre os JOBS
======================================================================
SQL> @jobs owner='SOE'
SQL> @job_details SOE UPDATE_STATS


======================================================================
== ğŸ¯ Executando o JOB
======================================================================
SQL> BEGIN
  -- Run job
  DBMS_SCHEDULER.run_job (job_name            => 'SOE.UPDATE_STATS',
                       use_current_session => FALSE);
 END;
/

SQL> @job_details SOE UPDATE_STATS


======================================================================
== ğŸ¯ Excluindo um JOB
======================================================================
SQL> BEGIN
-- DROP JOB
  DBMS_SCHEDULER.drop_job (job_name => '"SOE"."UPDATE_STATS"');
END;
/


======================================================================
== ğŸ¯ Criando um JOB com auto drop
======================================================================
SQL> BEGIN
    -- CREATE JOB
    dbms_scheduler.create_job
    (job_name       => 'SYS.DB_STATS', 
    job_type        => 'PLSQL_BLOCK', -- STORED_PROCEDURE or PLSQL_BLOCK
    job_action      => 'dbms_stats.gather_DATABASE_STATS;', 
    start_date      => sysdate, 
    enabled         => true, 
    auto_drop => true,
    comments        => 'Atualiza as estatÃ­sticas do banco inteiro');
END;
/


======================================================================
== ğŸ¯ Modificando um JOB
======================================================================
SQL> BEGIN
  DBMS_SCHEDULER.set_attribute (
    name      => 'SOE.UPDATE_STATS',
    attribute => 'repeat_interval',
    value     => 'FREQ=DAILY;BYHOUR=2;BYMINUTE=30');
END;
/


======================================================================
== ğŸ¯ Parando um JOB em execuÃ§Ã£o
======================================================================
SQL> @job_details SYS DB_STATS

SQL> BEGIN
  -- Stop jobs.
  DBMS_SCHEDULER.stop_job (job_name => 'SYS.DB_STATS');
END;
/

SQL> @job_details SYS DB_STATS

======================================================================
== ğŸ¯ Scripts Ãºteis
======================================================================
â–¶ï¸ @jobs
â–¶ï¸ @job_details
â–¶ï¸ @job_logs


=================================================================
== ğŸ¯ ConclusÃ£o
=================================================================
ğŸ’¡ Ã‰ importante que o DBA saiba lidar com agendamento de tarefas no banco
ğŸ’¡ Pratique a execuÃ§Ã£o dessas atividades!
ğŸ’¡ Salve os scripts utilizados nessa aula na sua pasta de scripts
ğŸ’¡ Domine os scripts utilizados nessa aula!

