|-------------------------------------------------------------------------------|
| Aula      : Par√¢metros de inicializa√ß√£o                                       |
| M√≥dulo    : Managing Oracle Database                                          |
| Curso     : Oracle Fundamentals                                               |
| Instrutor : Marcio Mandarino                                                  |
| URL       : mrdba.com.br/oracle_fundamentals                                  |
|-------------------------------------------------------------------------------|
| Refer√™ncia: https://docs.oracle.com/en/database/oracle/oracle-database/19/refrn/initialization-parameters-2.html#GUID-FD266F6F-D047-4EBB-8D96-B51B1DCA2D61
|-------------------------------------------------------------------------------|



=================================================================
== üéØ Objetivos da Aula
=================================================================
üí° Aprender o que s√£o os par√¢metros de inicializa√ß√£o
üí° Compreender a diferen√ßa entre spfile e pfile
üí° Saber como inicializar o banco usando o spfile e o pfile
üí° Fazer altera√ß√µes no banco de dados usando o spfile e pfile
üí° Como modificar par√¢metros em ambientes RAC

=================================================================
== üéØ Resumo
=================================================================
üìç Introdu√ß√£o
üìç PFILE (Parameter File)
üìç SPFILE (Server Parameter File)
üìç Par√¢metro Scope (spfile)
üìç Conte√∫do do spfile (exemplo)
üìç Conte√∫do do pfile (exemplo)
üìç Criando um pfile a partir do banco existente
üìç Iniciando o banco a partir do pfile
üìç Iniciando o banco a partir do spfile
üìç Alterando um par√¢metro de inicializa√ß√£o (Spfile)
üìç Alterando um par√¢metro de inicializa√ß√£o (pfile)
üìç Alterando um par√¢metro de inicializa√ß√£o no Oracle RAC (exemplo 1)
üìç Alterando um par√¢metro de inicializa√ß√£o no Oracle RAC (exemplo 2)
üìç Exerc√≠cios

=================================================================
== üéØ Introdu√ß√£o
=================================================================
‚ñ∂Ô∏è O Oracle utiliza arquivos de par√¢metros de inicializa√ß√£o para iniciar uma inst√¢ncia
‚ñ∂Ô∏è Esses arquivos cont√™m configura√ß√µes que ditam o comportamento do banco de dados.
‚ñ∂Ô∏è √â uma lista de par√¢metros de inicializa√ß√£o e seus respectivos valores
‚ñ∂Ô∏è Historicamente, o Oracle usava um arquivo baseado em texto chamado PFILE
‚ñ∂Ô∏è A partir do Oracle 9i, o Oracle introduziu uma vers√£o bin√°ria deste arquivo chamada SPFILE.


=================================================================
== üéØ PFILE (Parameter File)
=================================================================
‚ñ∂Ô∏è O pfile √© um arquivo de texto que cont√©m os parametros de inicializa√ß√£o
‚ñ∂Ô∏è O pfile se chama Parameter File, mas conveciou-se cham√°-lo de "pfile"
‚ñ∂Ô∏è Quando um banco de dados √© inicializado um arquivo de inicaliza√ß√£o √© lido (pfile ou spfile)
‚ñ∂Ô∏è O pfile n√£o √© usado por padr√£o, somente em situa√ß√µes espec√≠ficas 
  ‚ñ´Ô∏è Cria√ß√£o de um Data Guard
  ‚ñ´Ô∏è Cria√ß√£o de um banco do zero
‚ñ∂Ô∏è As altera√ß√µes no PFILE s√≥ entram em vigor ap√≥s uma reinicializa√ß√£o do banco de dados


=================================================================
== üéØ SPFILE (Server Parameter File)
=================================================================
‚ñ∂Ô∏è O spfile √© um arquivo bin√°rio que n√£o √© edit√°vel diretamente 
‚ñ∂Ô∏è Par√¢metros podem ser alterados enquanto o banco de dados est√° em execu√ß√£o
‚ñ∂Ô∏è O spfile √© o padr√£o a ser utilizado
‚ñ∂Ô∏è √â uma boa pr√°ticar fazer backup regular dos spfiles
‚ñ∂Ô∏è √â mais din√¢mico e f√°cil de trabalhar que o pfile


=================================================================
== üéØ Par√¢metro Scope (spfile)
=================================================================
‚ñ∂Ô∏è Define aonde a mudan√ßa ser√° realizada: spfile, memory ou both
  ‚ñ´Ô∏è spfile: A modifica√ß√£o √© realizada apenas no spfile, sem afetar a inst√¢ncia
  ‚ñ´Ô∏è memory: A modifica√ß√£o √© realizada apenas na inst√¢ncia, sem afetar o spfile
  ‚ñ´Ô∏è both: A modifica√ß√£o √© realizada tanto na inst√¢ncia quanto no spfile
‚ñ∂Ô∏è Nem todos os par√¢metros de inicializa√ß√£o permitem modifica√ß√µes em "memory"


=================================================================
== üéØ Conte√∫do do spfile (exemplo)
=================================================================
*.audit_trail='db'
*.compatible='19.0.0'
*.control_files='/redo1/oradata/cdb1/controlfile/o1_mf_ll81mzvf_.ctl','/redo2/oradata/cdb1/controlfile/o1_mf_ll81n003_.ctl'
*.db_block_size=8192
*.db_create_file_dest='/oradata'
*.db_create_online_log_dest_1='/redo1/oradata/'
*.db_create_online_log_dest_2='/redo2/oradata/'
*.db_name='cdb1'
*.db_recovery_file_dest='/backup'
*.db_recovery_file_dest_size=20480m
*.diagnostic_dest='/opt/oraCC"rTcle'
*.dispatchers='(PROTOCOL=TCP) (SERVICE=cdb1XDB)'
*.enable_pluggable_database=true
*.local_listener='LISTENER_cdb1'
*.nls_language='BRAZILIAN PORTUGUESE'
*.nls_territory='BRAZIL'
*.open_cursors=1000
*.pga_aggregate_target=512m
*.processes=600
*.remote_login_passwordfile='EXCLUSIVE'
*.sessions=600
*.sga_target=1536m
*.undo_tablespace='UNDOTBS1'


=================================================================
== üéØ Conte√∫do do pfile (exemplo)
=================================================================
*.audit_trail='db'
*.compatible='19.0.0'
*.control_files='/redo1/oradata/cdb1/controlfile/o1_mf_ll81mzvf_.ctl','/redo2/oradata/cdb1/controlfile/o1_mf_ll81n003_.ctl'
*.db_block_size=8192
*.db_create_file_dest='/oradata'
*.db_create_online_log_dest_1='/redo1/oradata/'
*.db_create_online_log_dest_2='/redo2/oradata/'
*.db_name='cdb1'
*.db_recovery_file_dest='/backup'
*.db_recovery_file_dest_size=20480m
*.diagnostic_dest='/opt/oraCC"rTcle'
*.dispatchers='(PROTOCOL=TCP) (SERVICE=cdb1XDB)'
*.enable_pluggable_database=true
*.local_listener='LISTENER_cdb1'
*.nls_language='BRAZILIAN PORTUGUESE'
*.nls_territory='BRAZIL'
*.open_cursors=1000
*.pga_aggregate_target=512m
*.processes=600
*.remote_login_passwordfile='EXCLUSIVE'
*.sessions=600
*.sga_target=1536m
*.undo_tablespace='UNDOTBS1'


=================================================================
== üéØ Criando um pfile a partir do banco existente
=================================================================
$ sqlplus / as sysdba

SQL> create pfile='/tmp/init_cdb1.ora' from spfile;
SQL> create pfile='/tmp/init_cdb12.ora' from memory;
SQL> exit

$ cat /tmp/init_cdb1.ora
$ cat /tmp/init_cdb12.ora


=================================================================
== üéØ Iniciando o banco a partir do pfile
=================================================================

SQL> show parameter spfile;
SQL> shutdown immediate;
SQL> startup nomount pfile='/tmp/init_cdb1.ora';
SQL> show parameter spfile;
SQL> exit

=================================================================
== üéØ Iniciando o banco a partir do spfile
=================================================================
$ cat /u01/app/oracle/product/19c/db_1/dbs/spfilecdb1.ora
$ mv /u01/app/oracle/product/19c/db_1/dbs/spfilecdb1.ora /u01/app/oracle/product/19c/db_1/dbs/spfilecdb1.old
$ ls -lhtr /u01/app/oracle/product/19c/db_1/dbs/spfilecdb1*

$ sqlplus / as sysdba
SQL> shutdown immediate;
SQL> startup nomount; -- default spfile 
SQL> !mv /u01/app/oracle/product/19c/db_1/dbs/spfilecdb1.old /u01/app/oracle/product/19c/db_1/dbs/spfilecdb1.ora
SQL> startup nomount;

=================================================================
== Consulta de Par√¢metros Oracle: Quais Podem Ser Alterados Online
=================================================================

SQL> desc v$parameter;
SQL> SELECT name, ISSYS_MODIFIABLE FROM v$parameter;


Veja qual o objetivo de dar esse comando ISSYS_MODIFIABLE ?

=================================================================
== üéØ Alterando um par√¢metro de inicializa√ß√£o (Spfile)
=================================================================
SQL> set lines 200
SQL> col name form a40
SQL> col value form a50
SQL> SELECT NAME,value ,ISDEFAULT,ISSYS_MODIFIABLE
FROM v$parameter
where name in ('db_recovery_file_dest_size','db_files')
ORDER BY 1;

SQL> show parameter db_recovery_file_dest_size;
SQL> show parameter recover;

-- Alterando o par√¢metro somente em mem√≥ria
SQL> alter system set db_recovery_file_dest_size = 10g scope=memory;
SQL> alter system set db_files = 500 scope=memory; --erro
SQL> show parameter db_recovery_file_dest_size;
SQL> shutdown immediate;
SQL> startup;
SQL> show parameter db_recovery_file_dest_size;

-- Alterando o par√¢metro somente no spfile
SQL> alter system set db_recovery_file_dest_size = 10g scope=spfile;
SQL> alter system set db_files = 500 scope=spfile;
SQL> show parameter db_recovery_file_dest_size;
SQL> shutdown immediate;
SQL> startup;
SQL> show parameter db_recovery_file_dest_size;
SQL> show parameter db_files;

-- Alterando o par√¢metro somente no spfile e em memory (both)
SQL> alter system set db_recovery_file_dest_size = 20g scope=both;
SQL> show parameter db_recovery_file_dest_size;
SQL> shutdown immediate;
SQL> startup;
SQL> show parameter db_recovery_file_dest_size;


=================================================================
== üéØ Alterando um par√¢metro de inicializa√ß√£o (pfile)
=================================================================

SQL> show parameter spfile;
SQL> shutdown immediate;

SQL> startup nomount pfile='/tmp/init_cdb1.ora';
SQL> show parameter spfile;
SQL> show parameter db_recovery_file_dest_size;

-- Altera o par√¢metro somente em mem√≥ria
SQL> alter system set db_recovery_file_dest_size = 10g scope=memory;
SQL> show parameter db_recovery_file_dest_size;
SQL> shutdown immediate;
SQL> startup nomount pfile='/tmp/init_cdb1.ora';
SQL> show parameter db_recovery_file_dest_size;


SQL> shutdown immediate;
SQL> exit

$ vi /tmp/init_cdb1.ora
$ sqlplus / as sysdba
SQL> startup nomount pfile='/tmp/init_cdb1.ora';
SQL> show parameter db_recovery_file_dest_size;


=================================================================
== üéØ Alterando um par√¢metro de inicializa√ß√£o no Oracle RAC (exemplo 1)
=================================================================
‚ÄºÔ∏è No Oracle RAC, s√≥ funciona o spfile

$ sqlplus / as sysdba
SQL> col name form a40
SQL> col value form a30
SQL> SET LINES 1000

SQL> SELECT INST_ID,NAME,value ,ISDEFAULT,ISSYS_MODIFIABLE
FROM gv$parameter
where name in ('sessions','db_files')
ORDER BY 2,1;

-- Modifica o par√¢metro em cada inst√¢ncia, de forma individual
SQL> alter system set sessions = 900 scope=spfile sid='rac1';
SQL> alter system set sessions = 800 scope=spfile sid='rac2';

-- Parando todas as inst√¢ncias do banco de uma vez s√≥ (gerando indisponibilidade)
$ srvctl stop database -d RAC -o IMMEDIATE

-- Iniciando todas as inst√¢ncias do banco
$ srvctl start database -d RAC

$ sqlplus / as sysdba
SQL> col name form a40
SQL> col value form a30
SQL> SET LINES 1000

SQL> SELECT INST_ID,NAME,value ,ISDEFAULT,ISSYS_MODIFIABLE
FROM gv$parameter
where name in ('sessions','db_files')
ORDER BY 2,1;


=================================================================
== üéØ Alterando um par√¢metro de inicializa√ß√£o no Oracle RAC (exemplo 2)
=================================================================

$ sqlplus / as sysdba
SQL> col name form a40
SQL> col value form a80
SQL> SET LINES 1000

SQL> SELECT INST_ID,NAME,value ,ISDEFAULT,ISSYS_MODIFIABLE
FROM gv$parameter
where name in ('processes')
ORDER BY 2,1;

-- Altera o par√¢metro em todas as inst√¢ncias
SQL> alter system set processes = 1200 scope=spfile sid='*';

-- Reinicando uma inst√¢ncia por vez (Mantendo a disponibilidade do banco)
$ srvctl stop instance -d RAC -i rac1 -o IMMEDIATE
$ srvctl start instance -d RAC -i rac1 

-- Reinicando uma inst√¢ncia por vez (Mantendo a disponibilidade do banco)
$ srvctl stop instance -d RAC -i rac2 -o IMMEDIATE
$ srvctl start instance -d RAC -i rac2 




$ sqlplus / as sysdba
SQL> col name form a40
SQL> col value form a40
SQL> SET LINES 1000

SQL> SELECT INST_ID,NAME,value ,ISDEFAULT,ISSYS_MODIFIABLE
FROM gv$parameter
where name in ('processes')
ORDER BY 2,1;


=================================================================
== üéØ Exerc√≠cios
=================================================================
1. Crie um arquivo pfile a partir do spfile
2. Inicie o banco a partir do pfile
3. Crie um spfile a partir do pfile
4. Reinicie o banco de dados usando o spfile
5. Altere o par√¢metro para large_pool_size no spfile para 64M (reinicie o banco)
6. Altere o par√¢metro para nls_language no spfile para 'AMERICAN' (reinicie o banco)
7. Inicie o banco com o pfile, usando processes e sessions com valor de 1000
8. Reinicie o banco de dados usando o spfile
9. Altere o par√¢metro session para 1000 apenas em mem√≥ria