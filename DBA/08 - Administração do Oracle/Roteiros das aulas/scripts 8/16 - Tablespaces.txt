|-------------------------------------------------------------------------------|
| Aula      : Gerenciando Tablespaces						                    |
| MÃ³dulo    : Managing Oracle Database                                          |
| Curso     : Oracle Fundamentals                                               |
| Instrutor : Marcio Mandarino                                                  |
| URL       : mrdba.com.br/oracle_fundamentals                                  |
|-------------------------------------------------------------------------------|
| ReferÃªncia: https://docs.oracle.com/en/database/oracle/oracle-database/23/admin/managing-tablespaces.html#GUID-9A3CE861-80FE-4813-B496-287B69A79C46
|-------------------------------------------------------------------------------|


=================================================================
== ğŸ¯ Objetivos da Aula:
=================================================================
ğŸ’¡ Compreender as atividades comuns de um DBA ao gerenciar tablespaces
ğŸ’¡ Aprender a criar, adicionar datafiles, mover datafiles e excluir tablespaces
ğŸ’¡ Explorar as views do dicionÃ¡rio de dados mais comuns relacionadas a tablespaces


=================================================================
== ğŸ¯ Resumo
=================================================================
ğŸ“ Conceito geral
ğŸ“ Criando tablespaces Smallfile
ğŸ“ Criando tablespaces Bigfile
ğŸ“ Adicionando Datafiles a uma Tablespace
ğŸ“ Alterando um datafile existente
ğŸ“ Gerenciando tablespaces em ambiente com ASM
ğŸ“ Excluindo uma tablespace
ğŸ“ Cuidados
ğŸ“ ConclusÃ£o

=================================================================
== ğŸ¯ Conceito geral
=================================================================
â–¶ï¸ Gerenciar tablespaces Ã© uma das atividades mais comuns de um DBA
â–¶ï¸ Eventualmente um DBA cria tablespaces
â–¶ï¸ Raramente um DBA exclui tablespaces
â–¶ï¸ Constantamente um DBA monitora tablespaces
â–¶ï¸ Cotidianamente um DBA adiciona mais espaÃ§o nas tablespaces
â–¶ï¸ As tablespaces armazenam segmentos que estÃ£o em constante crescimento
â–¶ï¸ Ã‰ comum termos vÃ¡rias tablespaces no banco
ğŸ’€ NÃ£o deixe as tablespaces do banco ficarem sem espaÃ§o


=================================================================
== ğŸ¯ Criando tablespaces Smallfile
=================================================================
â–¶ï¸ Alguns fatores influenciam a forma como vocÃª cria uma tablespace
    â–«ï¸ LocalizaÃ§Ã£o dos arquivos
    â–«ï¸ ParÃ¢metro db_create_file_dest
    â–«ï¸ Nome dos arquivos 

 SQL> SELECT NAME FROM V$DATAFILE;

-- Criando uma tablespace da forma mais simples (Usando OMF)
SQL> CREATE TABLESPACE ts_vendas_data;

-- Criando uma tablespace especificando size e autoextend (Usando OMF)
SQL> CREATE TABLESPACE ts_vendas_index datafile size 1g autoextend on next 1g maxsize 31g;

-- Criar uma tablespace com um datafile inicial de 100MB (Sem OMF)
SQL> CREATE TABLESPACE ts_vendas_lob
DATAFILE '/u02/oradata/ORCL/datafile/ts_vendas_lob_01.dbf' SIZE 100M
AUTOEXTEND ON NEXT 10M MAXSIZE UNLIMITED;

SQL> @ts
SQL> @df

ğŸ’¡ Crie o @df2 para filtrar os datafiles por tablespace!


=================================================================
== ğŸ¯ Criando tablespaces Bigfile
=================================================================
ğŸ’¡ SÃ£o tablespaces mais fÃ¡ceis de gerenciar, pois nÃ£o precisam ficar adicionando datafiles


-- Criando uma bigfile tablespace da forma mais simples (Usando OMF)
SQL> CREATE BIGFILE TABLESPACE ts_compras_data;

-- Criando uma bigfile tablespace especificando size e autoextend (Usando OMF)
SQL> CREATE BIGFILE TABLESPACE ts_compras_index datafile size 1g autoextend on next 1g maxsize 31g;

SQL> CREATE BIGFILE TABLESPACE ts_compras_index3 datafile size 1g autoextend on next 1g maxsize 1T;

-- Criar uma bigile tablespace com um datafile inicial de 100MB (Sem OMF)
SQL> CREATE BIGFILE TABLESPACE ts_compras_lob
DATAFILE '/u02/oradata/ORCL/datafile/ts_compras_data.dbf' SIZE 100M
AUTOEXTEND ON NEXT 10M MAXSIZE UNLIMITED;

SQL> SELECT tablespace_name, status, contents,BIGFILE
FROM dba_tablespaces;

SQL> col file_name form a80
SQL> SELECT file_name, tablespace_name, round(bytes/1024/1024,2) size_mb, autoextensible
FROM dba_data_files
where tablespace_name = 'TS_VENDAS_DATA';

=================================================================
== ğŸ¯ Adicionando Datafiles a uma Tablespace 
=================================================================
â–¶ï¸ Quando o espaÃ§o na tablespace fica reduzido, adicione mais datafile (smallfile tablespace)
â–¶ï¸ Procure ter um padrÃ£o. Eu gosto de manter as tablespaces com menos de 80% de ocupaÃ§Ã£o
ğŸ’¡ Essa atividade nÃ£o Ã© voltada para tablespaces bigfile!

SQL> CREATE TABLESPACE ts_teste datafile size 50M autoextend on next 100M maxsize 250M;

SQL> create table tb_teste tablespace ts_teste as (select * from dba_objects);
SQL> insert into tb_teste (select * from tb_teste);
SQL> @ts
SQL> insert into tb_teste (select * from tb_teste);
SQL> @ts
SQL> insert into tb_teste (select * from tb_teste);
SQL> @ts

insert into tb_teste (select * from tb_teste)
*
ERROR at line 1:
ORA-01653: unable to extend table SYSTEM.TB_TESTE by 1024 in tablespace TS_TESTE


-- Adicionando um datafile na tablespace sem especificar nada (Usando OMF)
SQL> alter TABLESPACE ts_teste add datafile size 1g autoextend on next 1g maxsize 31g;

-- Adicionando um datafile na tablespace especificando tamanho e autoextend (Usando OMF)
SQL> alter TABLESPACE ts_vendas_index add datafile size 1g autoextend on next 1g maxsize 31g;

-- Adicionar um novo datafile de 200MB a uma tablespace existente
ALTER TABLESPACE ts_vendas_lob
ADD DATAFILE '/u02/oradata/ORCL/datafile/ts_vendas_lob_02.dbf' SIZE 200M
AUTOEXTEND ON NEXT 10M MAXSIZE UNLIMITED;

SQL> col file_name form a80
SQL> SELECT file_name, tablespace_name, round(bytes/1024/1024,2) size_mb, autoextensible
FROM dba_data_files
where tablespace_name like'TS_VENDAS%'
order by 2,1;


=================================================================
== ğŸ¯ Alterando um datafile existente
=================================================================
â–¶ï¸ Essa Ã© uma ativide bem corriqueira
âš ï¸ Sempre fique atento ao espaÃ§o no disco que estÃ¡ sendo criado os datafiles
ğŸ’¡ Essa atividade nÃ£o causa indisponibilidade ao banco, ou seja, Ã© feita online

-- Smallfile tablespace
SQL> alter database datafile '/u02/oradata/ORCL/datafile/ts_vendas_lob_01.dbf' resize 200m;

-- Bigfile tablespace 
SQL> alter tablespace TS_COMPRAS_DATA resize 200m;

SQL> alter database datafile '/u02/oradata/ORCL/datafile/ts_vendas_lob_01.dbf' AUTOEXTEND ON NEXT 10M MAXSIZE UNLIMITED;

SQL> DESC DBA_DATA_FILES;
SQL> alter database datafile 12 resize 2g;


=================================================================
== ğŸ¯ Gerenciando tablespaces em ambiente com ASM
=================================================================
â–¶ï¸ Ã‰ exatamente a mesma coisa que ambientes com File System, basta ter os mesmos cuidados com a localizaÃ§Ã£o do arquivo

SQL> @df
SQL> @asm
SQL> show parameter db_create_file_dest

SQL> create tablespace ts_teste datafile '+DATA' size 100m autoextend on next 10m maxsize 100m;
SQL> alter TABLESPACE ts_teste add datafile '+DATA' size 150m autoextend on next 100m maxsize 1g;

SQL> create tablespace ts_teste2 datafile  size 100m autoextend on next 100m maxsize 1g;


=================================================================
== ğŸ¯ Excluindo uma tablespace
=================================================================
ğŸ’€ SÃ³ exclua uma tablespace que nÃ£o tenha segmentos!


SQL> drop tablespace ts_teste including contents and datafiles;
SQL> drop tablespace ts_teste2 including contents and datafiles;

SQL> drop tablespace ts_vendas_data including contents and datafiles;
SQL> drop tablespace ts_vendas_index including contents and datafiles;
SQL> drop tablespace ts_vendas_lob including contents and datafiles;
SQL> drop tablespace ts_compras_data including contents and datafiles;
SQL> drop tablespace ts_compras_index including contents and datafiles;
SQL> drop tablespace ts_compras_lob including contents and datafiles;
SQL> drop tablespace ts_teste including contents and datafiles;

create tablespace ts_teste;
create table T (data date) tablespace ts_teste;
insert into T values (sysdate);
commit;

select segment_name, tablespace_name 
from dba_segments where segment_name = 'T';

SELECT COUNT(1) from t;

SQL> drop tablespace ts_teste including contents and datafiles;


=================================================================
== ğŸ¯ Cuidados 
=================================================================
âš ï¸ Antes de criar um datafile ou uma tablespace, verifique se hÃ¡ espaÃ§o no ASM ou no File System
âš ï¸ Crie os datafiles no local correto
âš ï¸ NÃ£o deixe as tablespaces ficarem prÃ³ximos do limite do espaÃ§o
âš ï¸ Compreenda a diferenÃ§a entre o size atual e o maxsize da tablespace, isso causa confusÃ£o
âš ï¸ Cuidado ao excluir uma tablespace, verifique sempre se hÃ¡ segmentos nessa tablespace


=================================================================
== ğŸ¯ ConclusÃ£o
=================================================================
ğŸ’¡ Gerenciamento de tablespaces Ã© uma atividade crucial para qualquer DBA
ğŸ’¡ Domine todas as atividades desta aula
ğŸ’¡ Pratique a exaustÃ£o os comandos desta aula
ğŸ’¡ NÃ£o foque em decorar os comandos, compreenda eles
ğŸ’¡ Salve na sua pasta de howto os principais comandos
