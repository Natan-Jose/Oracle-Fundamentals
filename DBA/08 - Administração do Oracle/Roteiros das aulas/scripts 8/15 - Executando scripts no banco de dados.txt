|-------------------------------------------------------------------------------|
| Aula      : Executando scripts no banco de dados								|
| MÃ³dulo    : Managing Oracle Database                                          |
| Curso     : Oracle Fundamentals                                               |
| Instrutor : Marcio Mandarino                                                  |
| URL       : mrdba.com.br/oracle_fundamentals                                  |
|-------------------------------------------------------------------------------|
| ReferÃªncia: 
|-------------------------------------------------------------------------------|


=================================================================
== ğŸ¯ Objetivos da Aula:
=================================================================
ğŸ’¡ Aprender como executar scripts no banco de forma avanÃ§ada


=================================================================
== ğŸ¯ Resumo
=================================================================
ğŸ“ Conceito 
ğŸ“ Conceito geral
ğŸ“ Pontos importantes
ğŸ“ Executando um Script
ğŸ“ Comando ALTER SESSION SET CURRENT_SCHEMA
ğŸ“ set echo on
ğŸ“ spool
ğŸ“ Timing ON
ğŸ“ Time ON
ğŸ“ Executando mÃºltiplos scripts
ğŸ“ Verificando os objetos criados
ğŸ“ Compile os objetos invÃ¡lidos
ğŸ“ Problemas Comuns
ğŸ“ ConclusÃ£o

=================================================================
== ğŸ¯ Conceito geral
=================================================================
â–¶ï¸ Executar scripts no banco de dados Ã© uma atividade muito corriqueira para o DBA
â–¶ï¸ Normalmente Ã© uma atividade executada por DBA JÃºnior, estagiÃ¡rio ou pela equipe de N1
â–¶ï¸ Mas isso nÃ£o torna essa atividade exclusiva, DBAs SÃªniors tambÃ©m executam scripts
â–¶ï¸ Ã‰ comum ter muitos chamados (pedidos de atendimento) com essa finalidade
â–¶ï¸ Ã‰ uma atividade muito fÃ¡cil, porÃ©m como tudo em banco, Ã© preciso ter cautela


=================================================================
== ğŸ¯ Pontos importantes
=================================================================
â–¶ï¸ Antes de executar o script, Ã© preciso saber aonde vocÃª vai executar o script
	â–«ï¸ Ambiente (ProduÃ§Ã£o, HomologaÃ§Ã£o, Desenvolvimento)
	â–«ï¸ Servidor
	â–«ï¸ Banco
	â–«ï¸ Schema
â–¶ï¸ Saiba sempre os pontos acima, antes de excecutar um script no banco
â–¶ï¸ Normalmente esses tipos de pedido, chegam por email ou algum sistema de chamado
ğŸ’¡ Se no pedido nÃ£o estiver claro os pontos acima, levante essas informaÃ§Ãµes com o soliciante
ğŸ§¨ Cuidado com scripts que faÃ§am alteraÃ§Ãµes em bancos grandes e de grande volume de acesso
â–¶ï¸ Se vocÃª tiver vÃ¡rios scripts para rodar, a ordem pode importar
â–¶ï¸ O ideal Ã© que o script seja primeiro executado em homologaÃ§Ã£o&Dev para depois ser executado em produÃ§Ã£o
â–¶ï¸ Certifique-se de ter os privilÃ©gios necessÃ¡rios para executar a atividade


=================================================================
== ğŸ¯ Executando um Script
=================================================================

-- No SQL*Plus ou no Sql Developer
SQL> @C:\Users\planodba\Downloads\stage\dept.sql
SQL> @C:\Users\planodba\Downloads\stage\emp.sql

ğŸ’¡ Procure evitar espaÃ§os em branco no nome do script ou no caminho


=================================================================
== ğŸ¯ Comando ALTER SESSION SET CURRENT_SCHEMA
=================================================================
â–¶ï¸ O comando ALTER SESSION SET CURRENT_SCHEMA permite alterar o esquema atual da sessÃ£o sem precisar alterar o usuÃ¡rio conectado.

-- Verificar o esquema atual
SQL> SELECT SYS_CONTEXT('USERENV', 'CURRENT_SCHEMA') FROM DUAL;
SQL> show user;

-- Alterar o esquema atual para 'TESTE'
SQL> ALTER SESSION SET CURRENT_SCHEMA = TESTE;

-- Verificar o esquema atual
SQL> SELECT SYS_CONTEXT('USERENV', 'CURRENT_SCHEMA') FROM DUAL;
SQL> show user;
SQL> create table tb_teste (data date);
SQL> col object_name form a20
SQL> col owner form a20
SQL> select owner, object_name from dba_objects where object_name = 'TB_TESTE'


=================================================================
== ğŸ¯ set echo on
=================================================================
â–¶ï¸ O comando SET ECHO ON permite exibir os comandos SQL conforme sÃ£o executados, Ãºtil para depuraÃ§Ã£o e auditoria.

-- Habilitar a exibiÃ§Ã£o de comandos
SQL> SET ECHO ON
SQL> @C:\Users\planodba\Downloads\stage\inserts.sql
SQL> SET ECHO OFF
SQL> @C:\Users\planodba\Downloads\stage\simple_package.sql


=================================================================
== ğŸ¯ spool
=================================================================
â–¶ï¸ O comando SPOOL redireciona a saÃ­da de comandos SQL para um arquivo, permitindo salvar resultados e logs.

-- Iniciar a captura da saÃ­da em um arquivo
SQL> SPOOL C:\Users\planodba\Downloads\stage\calcularsalarioanual.log;
SQL> @C:\Users\planodba\Downloads\stage\simple_package.sql
SQL> SPOOL OFF;

ğŸ’¡ Envie o log para quem lhe fez a solicitaÃ§Ã£o


=================================================================
== ğŸ¯ Timing ON
=================================================================
â–¶ï¸ O comando SET TIMING ON exibe o tempo de execuÃ§Ã£o de cada comando SQL.

-- Habilitar a exibiÃ§Ã£o do tempo de execuÃ§Ã£o
SQL> SET TIMING ON

SQL> @C:\Users\planodba\Downloads\stage\get_emp_names.sql


=================================================================
== ğŸ¯ Time ON
=================================================================
â–¶ï¸ O comando SET TIME ON exibe a hora atual antes de cada prompt do SQL*Plus.

-- Habilitar a exibiÃ§Ã£o da hora atual
SQL> SET TIME ON

-- Comando SQL cujo horÃ¡rio de execuÃ§Ã£o serÃ¡ exibido
SQL> @C:\Users\planodba\Downloads\stage\vw_emp_dept.sql


=================================================================
== ğŸ¯ Executando mÃºltiplos scripts
=================================================================

executa_tudo.sql

set echo on
set timing on
set time on
set trimspool on
spool C:\Users\planodba\Downloads\stage\executa_tudo.log
@@dept.sql
@@emp.sql
@@inserts.sql
@@employees.sql
@@emp_log.sql
@@vw_emp_dept.sql
@@get_emp_names.sql
@@calcularsalarioanual.sql
@@simple_package.sql
spool off

alter session set current_schema = TESTE;

@C:\Users\planodba\Downloads\stage\executa_tudo.sql


=================================================================
== ğŸ¯ Verificando os objetos criados
=================================================================
ğŸ’¡ Sempre verifique o status dos objetos criados

âœ… Crie um script last_objects.sql na sua pasta de scripts!
SQL> col owner form a20
SQL> col object_name form a30
SQL> col object_type form a30
SQL> select owner, object_name, object_type, status, created
from dba_objects
where created > SYSDATE-&1/(24*60);

âš ï¸ Caso algum objeto fique invÃ¡lido apÃ³s a criaÃ§Ã£o, nÃ£o altere o cÃ³digo. Devolva ao solicitante


=================================================================
== ğŸ¯ Compile os objetos invÃ¡lidos
=================================================================
â–¶ï¸ Compile os objetos que ficaram invÃ¡lidos

SQL> @compile_schema NOME_SCHEMA


=================================================================
== ğŸ¯ Problemas Comuns
=================================================================
â–¶ï¸ Script errado / incompleto
â–¶ï¸ Script executado no lugar errado
â–¶ï¸ Falta de privilÃ©gios
ğŸ’€ Executar um script que altere algo em uma tabela gigante em horÃ¡rio de pico
	ğŸ’€ GeraÃ§Ã£o de bloqueios
	ğŸ’€ Pode travar a aplicaÃ§Ã£o
	ğŸ’€ Reverter o que foi feito pode demorar mais do que deixar terminar


=================================================================
== ğŸ¯ ConclusÃ£o
=================================================================
ğŸ’¡ Essa Ã© uma atividade cotidiana do DBA, domine-a.
ğŸ’¡ Ã‰ simples, Ã© fÃ¡cil, tem DBAs que ganham a vida sÃ³ fazendo isso!
ğŸ’¡ O segredo Ã© ter atenÃ§Ã£o e ser cuidadoso.
âš ï¸ AtenÃ§Ã£o com ambientes com grande volume de dados e de alto uso
 